#!/usr/bin/env node
/**
 * Generate Embedded SDK for Job Runtime
 *
 * Bundles the actual TypeScript SDK into a single JavaScript file
 * that can be embedded in the Go binary for use in Deno job runtime.
 *
 * Usage: npm run generate:embedded-sdk
 *
 * The generated file is written to: internal/jobs/embedded_sdk.js
 */

import { build } from 'esbuild';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const OUTPUT_FILE = path.join(__dirname, '..', '..', 'internal', 'jobs', 'embedded_sdk.js');
const RUNTIME_OUTPUT_FILE = path.join(__dirname, '..', '..', 'internal', 'runtime', 'embedded_sdk.js');
const ENTRY_FILE = path.join(__dirname, 'embedded-entry.js');

// Read version info
const packageJsonPath = path.join(__dirname, '..', 'package.json');
const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf-8'));

// Create a minimal entry point that exports what jobs need
const entryContent = `
// Entry point for embedded SDK - exports only what jobs need
export { FluxbaseClient, createClient } from '../src/client.ts';
export { QueryBuilder } from '../src/query-builder.ts';
export { FluxbaseStorage, StorageBucket } from '../src/storage.ts';
export { FluxbaseJobs } from '../src/jobs.ts';
export { FluxbaseAuth } from '../src/auth.ts';
export { FluxbaseFetch } from '../src/fetch.ts';
`;

fs.writeFileSync(ENTRY_FILE, entryContent);

// Ensure output directory exists
const outputDir = path.dirname(OUTPUT_FILE);
if (!fs.existsSync(outputDir)) {
  fs.mkdirSync(outputDir, { recursive: true });
}

try {
  // Bundle the SDK
  const result = await build({
    entryPoints: [ENTRY_FILE],
    bundle: true,
    format: 'iife',
    globalName: '_FluxbaseSDK',
    platform: 'neutral', // Neutral platform for Deno compatibility
    target: 'es2020',
    minify: true, // Minify for smaller binary size
    write: false,
    // Externalize node builtins and cross-fetch (Deno has native fetch)
    external: [
      'cross-fetch',
      'fs', 'path', 'os', 'crypto', 'child_process', 'tty',
      'http', 'https', 'stream', 'zlib', 'util', 'events', 'buffer', 'url'
    ],
    define: {
      'process.env.NODE_ENV': '"production"',
    },
    // Handle missing imports gracefully
    logLevel: 'warning',
  });

  const bundledCode = result.outputFiles[0].text;

  // Create the final output with header and helper functions
  const header = `/**
 * Fluxbase Embedded SDK for Job Runtime
 *
 * This file is auto-generated by bundling the TypeScript SDK.
 * DO NOT EDIT MANUALLY - changes will be overwritten.
 *
 * To regenerate: npm run generate:embedded-sdk (from sdk/ directory)
 * Source: sdk/src/*.ts
 *
 * SDK Version: ${packageJson.version}
 * Generated: ${new Date().toISOString()}
 *
 * @generated
 */

`;

  // Helper to create pre-configured clients
  const helpers = `
// Create pre-configured client using environment variables
function _createFluxbaseClient(url, token, clientName) {
  if (!url || !token) {
    console.error('[Fluxbase SDK] ' + clientName + ': Missing URL or token');
    return null;
  }
  try {
    return _FluxbaseSDK.createClient(url, token);
  } catch (e) {
    console.error('[Fluxbase SDK] ' + clientName + ': Failed to create client:', e.message);
    return null;
  }
}

// Expose createClient globally for user code
const createClient = _FluxbaseSDK.createClient;
`;

  const finalOutput = header + bundledCode + helpers;

  fs.writeFileSync(OUTPUT_FILE, finalOutput, 'utf-8');

  // Also write to runtime directory (used by functions and jobs runtime)
  const runtimeOutputDir = path.dirname(RUNTIME_OUTPUT_FILE);
  if (!fs.existsSync(runtimeOutputDir)) {
    fs.mkdirSync(runtimeOutputDir, { recursive: true });
  }
  fs.writeFileSync(RUNTIME_OUTPUT_FILE, finalOutput, 'utf-8');

  // Clean up temp entry file
  fs.unlinkSync(ENTRY_FILE);

  console.log('✅ Generated embedded SDK:');
  console.log('   - ' + OUTPUT_FILE);
  console.log('   - ' + RUNTIME_OUTPUT_FILE);
  console.log('   Size: ' + (finalOutput.length / 1024).toFixed(2) + ' KB');
  console.log('   Version: ' + packageJson.version);

} catch (error) {
  // Clean up temp entry file on error
  if (fs.existsSync(ENTRY_FILE)) {
    fs.unlinkSync(ENTRY_FILE);
  }
  console.error('❌ Failed to generate embedded SDK:', error.message);
  process.exit(1);
}
