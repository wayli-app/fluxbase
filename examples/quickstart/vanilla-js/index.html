<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fluxbase Vanilla JS Example</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
      line-height: 1.6;
    }
    h1 {
      margin-bottom: 2rem;
      color: #333;
    }
    .auth-section, .data-section, .realtime-section {
      background: #f5f5f5;
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1.5rem;
    }
    .auth-section h2, .data-section h2, .realtime-section h2 {
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button:hover {
      background: #0052a3;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    input {
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .user-info {
      background: white;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
    }
    .products-list {
      background: white;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
    }
    .product-item {
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }
    .product-item:last-child {
      border-bottom: none;
    }
    .realtime-log {
      background: white;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
    .log-entry {
      padding: 0.25rem 0;
      color: #666;
    }
    .log-entry.insert { color: #28a745; }
    .log-entry.update { color: #007bff; }
    .log-entry.delete { color: #dc3545; }
  </style>
</head>
<body>
  <h1>Fluxbase Vanilla JS Example</h1>

  <!-- Authentication Section -->
  <div class="auth-section">
    <h2>Authentication</h2>
    <div id="auth-status">Not logged in</div>
    <div style="margin-top: 1rem;">
      <input type="email" id="email" placeholder="Email" value="test@example.com">
      <input type="password" id="password" placeholder="Password" value="password123">
      <button onclick="signUp()">Sign Up</button>
      <button onclick="signIn()">Sign In</button>
      <button onclick="signOut()">Sign Out</button>
    </div>
    <div id="user-info" class="user-info" style="display:none;"></div>
  </div>

  <!-- Data Section -->
  <div class="data-section">
    <h2>Products Data</h2>
    <button onclick="fetchProducts()">Fetch Products</button>
    <button onclick="addProduct()">Add Random Product</button>
    <div id="products-list" class="products-list"></div>
  </div>

  <!-- Realtime Section -->
  <div class="realtime-section">
    <h2>Realtime Updates</h2>
    <button onclick="subscribeToProducts()">Subscribe to Products</button>
    <button onclick="unsubscribeFromProducts()">Unsubscribe</button>
    <div id="realtime-log" class="realtime-log"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@fluxbase/sdk@latest'

    // Create Fluxbase client
    window.client = createClient({
      url: 'http://localhost:8080',
      auth: {
        autoRefresh: true,
        persist: true,
      },
    })

    let realtimeChannel = null

    // Auth functions
    window.signUp = async () => {
      try {
        const email = document.getElementById('email').value
        const password = document.getElementById('password').value
        const session = await window.client.auth.signUp({ email, password })
        updateAuthStatus(session.user)
      } catch (error) {
        alert('Sign up failed: ' + error.message)
      }
    }

    window.signIn = async () => {
      try {
        const email = document.getElementById('email').value
        const password = document.getElementById('password').value
        const session = await window.client.auth.signIn({ email, password })
        updateAuthStatus(session.user)
      } catch (error) {
        alert('Sign in failed: ' + error.message)
      }
    }

    window.signOut = async () => {
      try {
        await window.client.auth.signOut()
        updateAuthStatus(null)
      } catch (error) {
        alert('Sign out failed: ' + error.message)
      }
    }

    function updateAuthStatus(user) {
      const statusEl = document.getElementById('auth-status')
      const userInfoEl = document.getElementById('user-info')

      if (user) {
        statusEl.textContent = `Logged in as ${user.email}`
        statusEl.style.color = 'green'
        userInfoEl.style.display = 'block'
        userInfoEl.innerHTML = `
          <strong>User ID:</strong> ${user.id}<br>
          <strong>Email:</strong> ${user.email}<br>
          <strong>Created:</strong> ${new Date(user.created_at).toLocaleString()}
        `
      } else {
        statusEl.textContent = 'Not logged in'
        statusEl.style.color = 'red'
        userInfoEl.style.display = 'none'
      }
    }

    // Data functions
    window.fetchProducts = async () => {
      try {
        const { data, error } = await window.client
          .from('products')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10)
          .execute()

        if (error) {
          document.getElementById('products-list').innerHTML = `<div>Error: ${error.message}</div>`
          return
        }

        if (!data || data.length === 0) {
          document.getElementById('products-list').innerHTML = '<div>No products found</div>'
          return
        }

        const html = data.map(p => `
          <div class="product-item">
            <strong>${p.name}</strong> - $${p.price} (${p.category})
          </div>
        `).join('')

        document.getElementById('products-list').innerHTML = html
      } catch (error) {
        document.getElementById('products-list').innerHTML = `<div>Error: ${error.message}</div>`
      }
    }

    window.addProduct = async () => {
      try {
        const names = ['Widget', 'Gadget', 'Gizmo', 'Doohickey', 'Thingamajig']
        const categories = ['electronics', 'home', 'sports', 'toys', 'books']

        const { data, error } = await window.client
          .from('products')
          .insert({
            name: names[Math.floor(Math.random() * names.length)] + ' ' + Math.random().toString(36).substring(7),
            price: Math.floor(Math.random() * 1000) + 10,
            category: categories[Math.floor(Math.random() * categories.length)],
          })

        if (error) {
          alert('Error adding product: ' + error.message)
        } else {
          alert('Product added successfully!')
          fetchProducts()
        }
      } catch (error) {
        alert('Error: ' + error.message)
      }
    }

    // Realtime functions
    window.subscribeToProducts = () => {
      if (realtimeChannel) {
        alert('Already subscribed!')
        return
      }

      realtimeChannel = window.client.realtime
        .channel('table:public.products')
        .on('INSERT', (payload) => {
          addLogEntry('INSERT', `New product: ${payload.new_record.name}`)
        })
        .on('UPDATE', (payload) => {
          addLogEntry('UPDATE', `Updated: ${payload.new_record.name}`)
        })
        .on('DELETE', (payload) => {
          addLogEntry('DELETE', `Deleted: ${payload.old_record.name}`)
        })
        .subscribe()

      addLogEntry('info', 'Subscribed to products table')
    }

    window.unsubscribeFromProducts = () => {
      if (!realtimeChannel) {
        alert('Not subscribed!')
        return
      }

      realtimeChannel.unsubscribe()
      realtimeChannel = null
      addLogEntry('info', 'Unsubscribed from products table')
    }

    function addLogEntry(type, message) {
      const logEl = document.getElementById('realtime-log')
      const entry = document.createElement('div')
      entry.className = `log-entry ${type}`
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`
      logEl.appendChild(entry)
      logEl.scrollTop = logEl.scrollHeight
    }

    // Check initial auth state
    const user = window.client.auth.getUser()
    if (user) {
      updateAuthStatus(user)
    }
  </script>
</body>
</html>
