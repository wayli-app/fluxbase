# ==============================================================================
# Fluxbase Development Docker Compose
# ==============================================================================
# Full configuration reference: See fluxbase.yaml.example
# All settings use FLUXBASE_ prefix (e.g., server.address -> FLUXBASE_SERVER_ADDRESS)
#
# Quick Start:
#   docker-compose up -d
#
# With custom configuration:
#   cp .env.example .env
#   # Edit .env with your settings
#   docker-compose up -d
# ==============================================================================

services:
  # PostgreSQL Database (with extensions for Fluxbase)
  postgres:
    image: ghcr.io/fluxbase-eu/fluxbase-postgres:18
    container_name: fluxbase-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-fluxbase}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-fluxbase}
      POSTGRES_DB: ${POSTGRES_DB:-fluxbase}
    volumes:
      - postgres_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-fluxbase}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fluxbase

  # MinIO (S3-compatible storage) - OPTIONAL
  # Uncomment this service if you want to use S3-compatible storage instead of local storage
  # Also update FLUXBASE_STORAGE_PROVIDER to 's3' in the fluxbase service below
  # minio:
  #   image: minio/minio:latest
  #   container_name: fluxbase-minio
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   ports:
  #     - "9000:9000"   # S3 API
  #     - "9001:9001"   # Web Console
  #   volumes:
  #     - minio_data:/data
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
  #     interval: 30s
  #     timeout: 20s
  #     retries: 3
  #   networks:
  #     - fluxbase

  # Dragonfly (Redis-compatible) - OPTIONAL
  # Uncomment this service for multi-instance deployments requiring distributed state.
  # Dragonfly is 25x faster than Redis with 80% less memory usage.
  # Also update FLUXBASE_SCALING_BACKEND to 'redis' in the fluxbase service below.
  # dragonfly:
  #   image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
  #   container_name: fluxbase-dragonfly
  #   # Uncomment the following line to enable password authentication:
  #   # command: dragonfly --requirepass ${DRAGONFLY_PASSWORD:-your-dragonfly-password}
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - dragonfly_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 5
  #   networks:
  #     - fluxbase

  # Fluxbase API
  fluxbase:
    image: ghcr.io/fluxbase-eu/fluxbase:2026.1.1-rc.4
    container_name: fluxbase
    ports:
      - "8080:8080"
    environment:
      # ==========================================================================
      # Server Configuration
      # ==========================================================================
      FLUXBASE_SERVER_ADDRESS: ${FLUXBASE_SERVER_ADDRESS:-0.0.0.0:8080}
      # FLUXBASE_SERVER_READ_TIMEOUT: "300s"
      # FLUXBASE_SERVER_WRITE_TIMEOUT: "300s"
      # FLUXBASE_SERVER_IDLE_TIMEOUT: "120s"
      # FLUXBASE_SERVER_BODY_LIMIT: "2147483648"  # 2GB

      # ==========================================================================
      # Database Configuration
      # ==========================================================================
      FLUXBASE_DATABASE_HOST: ${POSTGRES_HOST:-fluxbase-postgres}
      FLUXBASE_DATABASE_PORT: ${POSTGRES_PORT:-5432}
      FLUXBASE_DATABASE_DATABASE: ${POSTGRES_DB:-fluxbase}
      FLUXBASE_DATABASE_USER: ${POSTGRES_USER:-fluxbase}
      FLUXBASE_DATABASE_PASSWORD: ${POSTGRES_PASSWORD:-fluxbase}
      FLUXBASE_DATABASE_SSL_MODE: ${FLUXBASE_DATABASE_SSL_MODE:-disable}
      # FLUXBASE_DATABASE_MAX_CONNECTIONS: "25"
      # FLUXBASE_DATABASE_MIN_CONNECTIONS: "5"
      # FLUXBASE_DATABASE_MAX_CONN_LIFETIME: "1h"
      # FLUXBASE_DATABASE_MAX_CONN_IDLE_TIME: "30m"
      # Optional: Separate admin user for migrations (defaults to POSTGRES_USER if not set)
      # FLUXBASE_DATABASE_ADMIN_USER: ${POSTGRES_ADMIN_USER:-}
      # FLUXBASE_DATABASE_ADMIN_PASSWORD: ${POSTGRES_ADMIN_PASSWORD:-}
      # Optional: User migrations path
      # FLUXBASE_DATABASE_USER_MIGRATIONS_PATH: /migrations/user

      # ==========================================================================
      # Authentication Configuration
      # ==========================================================================
      # CRITICAL: Generate secrets with: openssl rand -base64 32
      # Or use: scripts/generate-keys.sh
      FLUXBASE_AUTH_JWT_SECRET: ${FLUXBASE_AUTH_JWT_SECRET:-haEae1GZfKa/lzMHyNFIR5iL0FZFIMMxMN3pb2jqCRc=}
      FLUXBASE_AUTH_JWT_EXPIRY: ${FLUXBASE_AUTH_JWT_EXPIRY:-15m}
      # FLUXBASE_AUTH_REFRESH_EXPIRY: "168h"
      # FLUXBASE_AUTH_MAGIC_LINK_EXPIRY: "15m"
      # FLUXBASE_AUTH_PASSWORD_RESET_EXPIRY: "1h"
      # FLUXBASE_AUTH_PASSWORD_MIN_LENGTH: "12"  # Increased for better security
      # FLUXBASE_AUTH_SERVICE_ROLE_TTL: "24h"  # Service role token expiration
      # FLUXBASE_AUTH_ANON_TTL: "24h"  # Anonymous token expiration
      # FLUXBASE_AUTH_BCRYPT_COST: "10"
      # FLUXBASE_AUTH_SIGNUP_ENABLED: "true"
      # FLUXBASE_AUTH_MAGIC_LINK_ENABLED: "true"
      # FLUXBASE_AUTH_TOTP_ISSUER: "Fluxbase"
      # FLUXBASE_AUTH_ALLOW_USER_CLIENT_KEYS: "${FLUXBASE_AUTH_ALLOW_USER_CLIENT_KEYS:-true}"  # Allow users to create their own client keys

      # Anon Key: Pre-generated JWT with 'anon' role for client-side apps
      # Generate with: scripts/generate-keys.sh (option 3)
      # Use in client apps as: VITE_FLUXBASE_ANON_KEY, NEXT_PUBLIC_FLUXBASE_ANON_KEY, etc.
      # FLUXBASE_AUTH_ANON_KEY: ""

      # ==========================================================================
      # OAuth/OIDC Configuration (Social Login & Enterprise SSO)
      # ==========================================================================
      # Configure OAuth 2.0 and OIDC providers using indexed environment variables
      # Well-known providers (google, apple, microsoft) auto-detect issuer URLs
      #
      # Example: Google OAuth
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_0_NAME: "google"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_0_ENABLED: "true"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_0_CLIENT_ID: "YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_0_CLIENT_SECRET: "YOUR_GOOGLE_CLIENT_SECRET"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_0_SCOPES: "openid,email,profile"
      # RBAC (optional)
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_0_REQUIRED_CLAIMS: '{"roles":["admin","editor"]}'
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_0_DENIED_CLAIMS: '{"status":["suspended"]}'
      #
      # Example: Custom OIDC provider (Keycloak)
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_1_NAME: "keycloak"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_1_ENABLED: "true"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_1_ISSUER_URL: "https://auth.example.com/realms/main"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_1_CLIENT_ID: "fluxbase-client"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_1_CLIENT_SECRET: "YOUR_KEYCLOAK_SECRET"
      # FLUXBASE_AUTH_OAUTH_PROVIDERS_1_SCOPES: "openid,email,profile"
      #
      # Provider Setup Steps:
      # 1. Create OAuth application in provider's developer console
      # 2. Set redirect URI to: http://localhost:8080/api/v1/auth/oauth/{provider}/callback
      # 3. Get client ID and client secret
      # 4. Configure using environment variables above
      #
      # Well-Known Providers (issuer auto-detected):
      #   - google: https://accounts.google.com
      #   - apple: https://appleid.apple.com
      #   - microsoft: https://login.microsoftonline.com/common/v2.0

      # ==========================================================================
      # SAML SSO Configuration (Enterprise Single Sign-On)
      # ==========================================================================
      # Example for Okta/Azure AD/OneLogin integration
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_NAME: "okta"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_ENABLED: "true"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_IDP_METADATA_URL: "https://company.okta.com/app/xxx/sso/saml/metadata"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_ENTITY_ID: "https://your-app.com/auth/saml"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_ACS_URL: "https://your-app.com/api/v1/auth/saml/acs"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_AUTO_CREATE_USERS: "true"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_DEFAULT_ROLE: "authenticated"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_ALLOW_APP_LOGIN: "true"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_ALLOW_DASHBOARD_LOGIN: "false"
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_ALLOW_IDP_INITIATED: "false"  # Security: disable IdP-initiated SSO
      # RBAC (optional)
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_REQUIRED_GROUPS: '["FluxbaseAdmins","IT-Team"]'
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_REQUIRED_GROUPS_ALL: '["Employees","Active"]'
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_DENIED_GROUPS: '["Contractors","Suspended"]'
      # FLUXBASE_AUTH_SAML_PROVIDERS_0_GROUP_ATTRIBUTE: "groups"

      # ==========================================================================
      # Security Configuration
      # ==========================================================================
      # CRITICAL: Generate with: openssl rand -base64 32
      FLUXBASE_SECURITY_SETUP_TOKEN: ${FLUXBASE_SECURITY_SETUP_TOKEN:-your-secret-setup-token-change-in-production}
      # FLUXBASE_SECURITY_ENABLE_GLOBAL_RATE_LIMIT: "false"
      # FLUXBASE_SECURITY_ADMIN_SETUP_RATE_LIMIT: "5"
      # FLUXBASE_SECURITY_ADMIN_SETUP_RATE_WINDOW: "15m"  # 15 minutes
      # FLUXBASE_SECURITY_AUTH_LOGIN_RATE_LIMIT: "10"
      # FLUXBASE_SECURITY_AUTH_LOGIN_RATE_WINDOW: "1m"
      # FLUXBASE_SECURITY_ADMIN_LOGIN_RATE_LIMIT: "10"  # Updated from 5 to 10
      # FLUXBASE_SECURITY_ADMIN_LOGIN_RATE_WINDOW: "1m"

      # ==========================================================================
      # CORS Configuration
      # ==========================================================================
      # FLUXBASE_CORS_ALLOWED_ORIGINS: "*"
      # FLUXBASE_CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
      # FLUXBASE_CORS_ALLOWED_HEADERS: "*"
      # FLUXBASE_CORS_ALLOW_CREDENTIALS: "true"
      # FLUXBASE_CORS_MAX_AGE: "86400"

      # ==========================================================================
      # Storage Configuration
      # ==========================================================================
      FLUXBASE_STORAGE_ENABLED: ${FLUXBASE_STORAGE_ENABLED:-true}
      FLUXBASE_STORAGE_PROVIDER: ${FLUXBASE_STORAGE_PROVIDER:-local}
      FLUXBASE_STORAGE_LOCAL_PATH: ${FLUXBASE_STORAGE_LOCAL_PATH:-/app/storage}
      # FLUXBASE_STORAGE_MAX_UPLOAD_SIZE: "2147483648"  # 2GB

      # For S3-compatible storage (e.g., MinIO), uncomment below:
      # FLUXBASE_STORAGE_PROVIDER: s3
      # FLUXBASE_STORAGE_S3_BUCKET: fluxbase
      # FLUXBASE_STORAGE_S3_REGION: us-east-1
      # FLUXBASE_STORAGE_S3_ENDPOINT: http://minio:9000
      # FLUXBASE_STORAGE_S3_ACCESS_KEY: minioadmin
      # FLUXBASE_STORAGE_S3_SECRET_KEY: minioadmin
      # FLUXBASE_STORAGE_S3_FORCE_PATH_STYLE: "true"
      # FLUXBASE_STORAGE_DEFAULT_BUCKETS: "uploads,temp-files,public"  # Auto-create buckets on startup

      # Image Transformation Settings (requires libvips)
      # FLUXBASE_STORAGE_TRANSFORMS_ENABLED: "true"
      # FLUXBASE_STORAGE_TRANSFORMS_DEFAULT_QUALITY: "80"
      # FLUXBASE_STORAGE_TRANSFORMS_MAX_WIDTH: "4096"
      # FLUXBASE_STORAGE_TRANSFORMS_MAX_HEIGHT: "4096"
      # FLUXBASE_STORAGE_TRANSFORMS_ALLOWED_FORMATS: "webp,jpg,png,avif"
      # FLUXBASE_STORAGE_TRANSFORMS_MAX_TOTAL_PIXELS: "16000000"  # 16 megapixels
      # FLUXBASE_STORAGE_TRANSFORMS_BUCKET_SIZE: "50"  # Round dimensions to 50px
      # FLUXBASE_STORAGE_TRANSFORMS_RATE_LIMIT: "60"  # 60 transforms/min/user
      # FLUXBASE_STORAGE_TRANSFORMS_TIMEOUT: "30s"
      # FLUXBASE_STORAGE_TRANSFORMS_MAX_CONCURRENT: "4"
      # FLUXBASE_STORAGE_TRANSFORMS_CACHE_ENABLED: "true"
      # FLUXBASE_STORAGE_TRANSFORMS_CACHE_TTL: "24h"
      # FLUXBASE_STORAGE_TRANSFORMS_CACHE_MAX_SIZE: "1073741824"  # 1GB

      # ==========================================================================
      # Realtime (WebSocket) Configuration
      # ==========================================================================
      FLUXBASE_REALTIME_ENABLED: ${FLUXBASE_REALTIME_ENABLED:-true}
      # FLUXBASE_REALTIME_MAX_CONNECTIONS: "1000"
      # FLUXBASE_REALTIME_PING_INTERVAL: "30s"
      # FLUXBASE_REALTIME_PONG_TIMEOUT: "60s"
      # FLUXBASE_REALTIME_MESSAGE_SIZE_LIMIT: "524288"  # 512KB

      # ==========================================================================
      # Email Configuration (optional)
      # ==========================================================================
      # FLUXBASE_EMAIL_ENABLED: "true"
      # FLUXBASE_EMAIL_PROVIDER: "smtp"  # smtp, sendgrid, mailgun, ses
      # FLUXBASE_EMAIL_FROM_ADDRESS: "noreply@localhost"
      # FLUXBASE_EMAIL_FROM_NAME: "Fluxbase"

      # SMTP Configuration
      # FLUXBASE_EMAIL_SMTP_HOST: ""
      # FLUXBASE_EMAIL_SMTP_PORT: "587"
      # FLUXBASE_EMAIL_SMTP_USERNAME: ""
      # FLUXBASE_EMAIL_SMTP_PASSWORD: ""
      # FLUXBASE_EMAIL_SMTP_TLS: "true"

      # SendGrid Configuration
      # FLUXBASE_EMAIL_SENDGRID_API_KEY: ""

      # Mailgun Configuration
      # FLUXBASE_EMAIL_MAILGUN_API_KEY: ""
      # FLUXBASE_EMAIL_MAILGUN_DOMAIN: ""

      # AWS SES Configuration
      # FLUXBASE_EMAIL_SES_ACCESS_KEY: ""
      # FLUXBASE_EMAIL_SES_SECRET_KEY: ""
      # FLUXBASE_EMAIL_SES_REGION: "us-east-1"

      # Email Template Paths (optional - use custom HTML templates)
      # FLUXBASE_EMAIL_MAGIC_LINK_TEMPLATE: "/templates/magic-link.html"
      # FLUXBASE_EMAIL_VERIFICATION_TEMPLATE: "/templates/verify.html"
      # FLUXBASE_EMAIL_PASSWORD_RESET_TEMPLATE: "/templates/reset.html"

      # ==========================================================================
      # Edge Functions Configuration
      # ==========================================================================
      FLUXBASE_FUNCTIONS_ENABLED: ${FLUXBASE_FUNCTIONS_ENABLED:-true}
      FLUXBASE_FUNCTIONS_FUNCTIONS_DIR: ${FLUXBASE_FUNCTIONS_FUNCTIONS_DIR:-/app/functions}
      # FLUXBASE_FUNCTIONS_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_FUNCTIONS_DEFAULT_TIMEOUT: "30"
      # FLUXBASE_FUNCTIONS_MAX_TIMEOUT: "300"
      # FLUXBASE_FUNCTIONS_DEFAULT_MEMORY_LIMIT: "128"
      # FLUXBASE_FUNCTIONS_MAX_MEMORY_LIMIT: "1024"
      # FLUXBASE_FUNCTIONS_SYNC_ALLOWED_IP_RANGES: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16,127.0.0.0/8"

      # ==========================================================================
      # Jobs Configuration
      # ==========================================================================
      # FLUXBASE_JOBS_ENABLED: "true"
      # FLUXBASE_JOBS_JOBS_DIR: "/app/jobs"
      # FLUXBASE_JOBS_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_JOBS_WORKER_MODE: "embedded"
      # FLUXBASE_JOBS_EMBEDDED_WORKER_COUNT: "4"
      # FLUXBASE_JOBS_MAX_CONCURRENT_PER_WORKER: "10"
      # FLUXBASE_JOBS_SYNC_ALLOWED_IP_RANGES: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16,127.0.0.0/8"
      # Execution logs retention (days)
      # FLUXBASE_JOBS_FUNCTIONS_LOGS_RETENTION_DAYS: "30"
      # FLUXBASE_JOBS_RPC_LOGS_RETENTION_DAYS: "30"
      # FLUXBASE_JOBS_JOBS_LOGS_RETENTION_DAYS: "30"

      # ==========================================================================
      # CAPTCHA Configuration (optional)
      # ==========================================================================
      # Supported providers: hcaptcha, recaptcha_v3, turnstile, cap
      # FLUXBASE_SECURITY_CAPTCHA_ENABLED: "false"
      # FLUXBASE_SECURITY_CAPTCHA_PROVIDER: "hcaptcha"
      # FLUXBASE_SECURITY_CAPTCHA_SITE_KEY: ""
      # FLUXBASE_SECURITY_CAPTCHA_SECRET_KEY: ""
      # FLUXBASE_SECURITY_CAPTCHA_SCORE_THRESHOLD: "0.5"  # reCAPTCHA v3 only
      # FLUXBASE_SECURITY_CAPTCHA_ENDPOINTS: "signup,login,password_reset,magic_link"
      # Cap provider settings (self-hosted proof-of-work CAPTCHA - https://capjs.js.org/)
      # FLUXBASE_SECURITY_CAPTCHA_CAP_SERVER_URL: "http://localhost:3000"
      # FLUXBASE_SECURITY_CAPTCHA_CAP_API_KEY: ""

      # ==========================================================================
      # REST API Configuration
      # ==========================================================================
      # FLUXBASE_API_MAX_PAGE_SIZE: "1000"
      # FLUXBASE_API_MAX_TOTAL_RESULTS: "10000"
      # FLUXBASE_API_DEFAULT_PAGE_SIZE: "1000"

      # ==========================================================================
      # GraphQL Configuration
      # ==========================================================================
      FLUXBASE_GRAPHQL_ENABLED: ${FLUXBASE_GRAPHQL_ENABLED:-true}
      FLUXBASE_GRAPHQL_MAX_DEPTH: ${FLUXBASE_GRAPHQL_MAX_DEPTH:-10}
      FLUXBASE_GRAPHQL_MAX_COMPLEXITY: ${FLUXBASE_GRAPHQL_MAX_COMPLEXITY:-1000}
      # Disable introspection in production for security
      FLUXBASE_GRAPHQL_INTROSPECTION: ${FLUXBASE_GRAPHQL_INTROSPECTION:-false}

      # ==========================================================================
      # Migrations Configuration
      # ==========================================================================
      # FLUXBASE_MIGRATIONS_ENABLED: "true"
      # FLUXBASE_MIGRATIONS_REQUIRE_SERVICE_KEY: "false"

      # ==========================================================================
      # RPC Configuration
      # ==========================================================================
      # FLUXBASE_RPC_ENABLED: "true"
      # FLUXBASE_RPC_PROCEDURES_DIR: "/app/procedures"
      # FLUXBASE_RPC_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_RPC_DEFAULT_MAX_EXECUTION_TIME: "30s"
      # FLUXBASE_RPC_MAX_MAX_EXECUTION_TIME: "300s"
      # FLUXBASE_RPC_DEFAULT_MAX_ROWS: "1000"
      # FLUXBASE_RPC_SYNC_ALLOWED_IP_RANGES: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16,127.0.0.0/8"

      # ==========================================================================
      # AI Configuration (optional)
      # ==========================================================================
      # FLUXBASE_AI_ENABLED: "false"
      # FLUXBASE_AI_CHATBOTS_DIR: "/app/chatbots"
      # FLUXBASE_AI_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_AI_DEFAULT_MAX_TOKENS: "4096"
      # FLUXBASE_AI_DEFAULT_MODEL: "gpt-4-turbo"
      # FLUXBASE_AI_QUERY_TIMEOUT: "30s"
      # FLUXBASE_AI_MAX_ROWS_PER_QUERY: "1000"
      # FLUXBASE_AI_SYNC_ALLOWED_IP_RANGES: "172.16.0.0/12,10.0.0.0/8,192.168.0.0/16,127.0.0.0/8"

      # OpenAI Configuration
      # FLUXBASE_AI_OPENAI_API_KEY: ""
      # FLUXBASE_AI_OPENAI_ORGANIZATION_ID: ""
      # FLUXBASE_AI_OPENAI_BASE_URL: ""

      # Azure OpenAI Configuration
      # FLUXBASE_AI_AZURE_API_KEY: ""
      # FLUXBASE_AI_AZURE_ENDPOINT: ""
      # FLUXBASE_AI_AZURE_DEPLOYMENT_NAME: ""
      # FLUXBASE_AI_AZURE_API_VERSION: ""
      # FLUXBASE_AI_AZURE_EMBEDDING_DEPLOYMENT_NAME: ""

      # Ollama Configuration
      # FLUXBASE_AI_OLLAMA_ENDPOINT: ""
      # FLUXBASE_AI_OLLAMA_MODEL: ""

      # Embedding Configuration (for vector search / knowledge bases)
      # Embeddings are auto-enabled when an AI provider with embedding support is configured
      # FLUXBASE_AI_EMBEDDING_ENABLED: "false"
      # FLUXBASE_AI_EMBEDDING_PROVIDER: ""  # openai, azure, ollama (defaults to provider_type)
      # FLUXBASE_AI_EMBEDDING_MODEL: ""  # Empty = provider default (openai: text-embedding-3-small, azure: text-embedding-ada-002, ollama: nomic-embed-text)

      # OCR Configuration (for image-based PDF extraction in knowledge bases)
      # FLUXBASE_AI_OCR_ENABLED: "false"
      # FLUXBASE_AI_OCR_PROVIDER: "tesseract"
      # FLUXBASE_AI_OCR_LANGUAGES: "eng"  # Comma-separated, e.g., "eng,deu"

      # ==========================================================================
      # Logging Configuration
      # ==========================================================================
      # FLUXBASE_LOGGING_CONSOLE_ENABLED: "true"
      # FLUXBASE_LOGGING_CONSOLE_LEVEL: "info"
      # FLUXBASE_LOGGING_CONSOLE_FORMAT: "json"
      # FLUXBASE_LOGGING_BACKEND: "postgres"
      # FLUXBASE_LOGGING_BATCH_SIZE: "100"
      # FLUXBASE_LOGGING_FLUSH_INTERVAL: "5s"
      # FLUXBASE_LOGGING_PUBSUB_ENABLED: "true"
      # FLUXBASE_LOGGING_RETENTION_ENABLED: "true"
      # FLUXBASE_LOGGING_SYSTEM_RETENTION_DAYS: "30"
      # FLUXBASE_LOGGING_HTTP_RETENTION_DAYS: "7"
      # FLUXBASE_LOGGING_SECURITY_RETENTION_DAYS: "90"
      # FLUXBASE_LOGGING_EXECUTION_RETENTION_DAYS: "7"
      # FLUXBASE_LOGGING_AI_RETENTION_DAYS: "30"
      # Custom categories
      # FLUXBASE_LOGGING_CUSTOM_CATEGORIES: "audit,analytics"
      # FLUXBASE_LOGGING_CUSTOM_RETENTION_DAYS: "30"

      # ==========================================================================
      # Tracing Configuration (OpenTelemetry)
      # ==========================================================================
      # FLUXBASE_TRACING_ENABLED: "false"
      # FLUXBASE_TRACING_ENDPOINT: "localhost:4317"
      # FLUXBASE_TRACING_SERVICE_NAME: "fluxbase"
      # FLUXBASE_TRACING_ENVIRONMENT: "development"
      # FLUXBASE_TRACING_SAMPLE_RATE: "0.1"
      # FLUXBASE_TRACING_INSECURE: "true"

      # ==========================================================================
      # Admin Dashboard Configuration
      # ==========================================================================
      # Enable admin dashboard UI and API routes
      # Requires FLUXBASE_SECURITY_SETUP_TOKEN to also be set
      FLUXBASE_ADMIN_ENABLED: ${FLUXBASE_ADMIN_ENABLED:-true}

      # ==========================================================================
      # Encryption Configuration (REQUIRED)
      # ==========================================================================
      # REQUIRED: Encryption key for sensitive data at rest (secrets, OAuth tokens, client keys)
      # Fluxbase will not start without this key set.
      # Must be exactly 32 characters for AES-256-GCM encryption.
      # Generate with: openssl rand -base64 32 | head -c 32
      FLUXBASE_ENCRYPTION_KEY: ${FLUXBASE_ENCRYPTION_KEY:-your-32-character-encryption-key}

      # ==========================================================================
      # General Configuration
      # ==========================================================================
      # Internal URL for server-to-server communication (e.g., edge functions calling the API)
      FLUXBASE_BASE_URL: ${FLUXBASE_BASE_URL:-http://localhost:8080}
      # Public URL for user-facing links (OAuth callbacks, magic links, invitation emails)
      # Set this when deploying behind a reverse proxy, load balancer, or ingress
      # Example: FLUXBASE_PUBLIC_BASE_URL: https://api.example.com
      # FLUXBASE_PUBLIC_BASE_URL: ${FLUXBASE_PUBLIC_BASE_URL:-}
      FLUXBASE_DEBUG: ${FLUXBASE_DEBUG:-false}

      # ==========================================================================
      # Model Context Protocol (MCP) Configuration - OPTIONAL
      # ==========================================================================
      # Enables AI assistants to interact with your Fluxbase instance
      # FLUXBASE_MCP_ENABLED: "false"
      # FLUXBASE_MCP_BASE_PATH: "/mcp"
      # FLUXBASE_MCP_SESSION_TIMEOUT: "30m"
      # FLUXBASE_MCP_MAX_MESSAGE_SIZE: "10485760"  # 10MB
      # FLUXBASE_MCP_RATE_LIMIT_PER_MIN: "100"

      # ==========================================================================
      # Database Branching Configuration - OPTIONAL
      # ==========================================================================
      # Create isolated database branches for development/testing
      # FLUXBASE_BRANCHING_ENABLED: "false"
      # FLUXBASE_BRANCHING_MAX_BRANCHES_PER_USER: "5"
      # FLUXBASE_BRANCHING_MAX_TOTAL_BRANCHES: "50"
      # FLUXBASE_BRANCHING_DEFAULT_DATA_CLONE_MODE: "schema_only"
      # FLUXBASE_BRANCHING_AUTO_DELETE_AFTER: "0"  # 0 = never, e.g., "24h"
      # FLUXBASE_BRANCHING_DATABASE_PREFIX: "branch_"

      # ==========================================================================
      # Horizontal Scaling Configuration - OPTIONAL
      # ==========================================================================
      # Backend options: "local" (default), "postgres", "redis"
      # - local: In-memory (single instance only)
      # - postgres: Uses PostgreSQL for distributed state (no extra dependencies)
      # - redis: Uses Redis-compatible backend (Dragonfly recommended)
      # FLUXBASE_SCALING_BACKEND: postgres
      # FLUXBASE_SCALING_ENABLE_SCHEDULER_LEADER_ELECTION: "true"
      # FLUXBASE_SCALING_WORKER_ONLY: "false"
      # FLUXBASE_SCALING_DISABLE_SCHEDULER: "false"
      # FLUXBASE_SCALING_DISABLE_REALTIME: "false"
      # For Redis/Dragonfly backend:
      # FLUXBASE_SCALING_REDIS_URL: redis://dragonfly:6379
      # With password: FLUXBASE_SCALING_REDIS_URL: redis://:your-password@dragonfly:6379

    volumes:
      - storage_data:/app/storage
    depends_on:
      postgres:
        condition: service_healthy
      # Uncomment if using MinIO:
      # minio:
      #   condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://0.0.0.0:8080/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - fluxbase
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  storage_data:
    driver: local

networks:
  fluxbase:
    driver: bridge
