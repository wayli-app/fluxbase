version: "3.8"

# ==============================================================================
# Fluxbase Development Docker Compose
# ==============================================================================
# Full configuration reference: See fluxbase.yaml.example
# All settings use FLUXBASE_ prefix (e.g., server.address -> FLUXBASE_SERVER_ADDRESS)
#
# Quick Start:
#   docker-compose up -d
#
# With custom configuration:
#   cp .env.example .env
#   # Edit .env with your settings
#   docker-compose up -d
# ==============================================================================

services:
  # PostgreSQL Database (with extensions for Fluxbase)
  postgres:
    image: ghcr.io/fluxbase-eu/fluxbase-postgres:18
    container_name: fluxbase-postgres
    environment:
      POSTGRES_USER: fluxbase
      POSTGRES_PASSWORD: fluxbase
      POSTGRES_DB: fluxbase
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fluxbase"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fluxbase

  # MinIO (S3-compatible storage) - OPTIONAL
  # Uncomment this service if you want to use S3-compatible storage instead of local storage
  # Also update FLUXBASE_STORAGE_PROVIDER to 's3' in the fluxbase service below
  # minio:
  #   image: minio/minio:latest
  #   container_name: fluxbase-minio
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   ports:
  #     - "9000:9000"   # S3 API
  #     - "9001:9001"   # Web Console
  #   volumes:
  #     - minio_data:/data
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
  #     interval: 30s
  #     timeout: 20s
  #     retries: 3
  #   networks:
  #     - fluxbase

  # Dragonfly (Redis-compatible) - OPTIONAL
  # Uncomment this service for multi-instance deployments requiring distributed state.
  # Dragonfly is 25x faster than Redis with 80% less memory usage.
  # Also update FLUXBASE_SCALING_BACKEND to 'redis' in the fluxbase service below.
  # dragonfly:
  #   image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
  #   container_name: fluxbase-dragonfly
  #   # Uncomment the following line to enable password authentication:
  #   # command: dragonfly --requirepass ${DRAGONFLY_PASSWORD:-your-dragonfly-password}
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - dragonfly_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 3s
  #     retries: 5
  #   networks:
  #     - fluxbase

  # Fluxbase API
  fluxbase:
    image: ghcr.io/fluxbase-eu/fluxbase:0.0.1-rc.59
    container_name: fluxbase-api
    ports:
      - "8080:8080"
    environment:
      # ==========================================================================
      # Server Configuration
      # ==========================================================================
      FLUXBASE_SERVER_ADDRESS: "0.0.0.0:8080"
      # FLUXBASE_SERVER_READ_TIMEOUT: "300s"
      # FLUXBASE_SERVER_WRITE_TIMEOUT: "300s"
      # FLUXBASE_SERVER_IDLE_TIMEOUT: "120s"
      # FLUXBASE_SERVER_BODY_LIMIT: "2147483648"  # 2GB

      # ==========================================================================
      # Database Configuration
      # ==========================================================================
      FLUXBASE_DATABASE_HOST: postgres
      FLUXBASE_DATABASE_PORT: 5432
      FLUXBASE_DATABASE_DATABASE: fluxbase
      FLUXBASE_DATABASE_USER: fluxbase
      FLUXBASE_DATABASE_PASSWORD: fluxbase
      FLUXBASE_DATABASE_SSL_MODE: disable
      # FLUXBASE_DATABASE_MAX_CONNECTIONS: "25"
      # FLUXBASE_DATABASE_MIN_CONNECTIONS: "5"
      # FLUXBASE_DATABASE_MAX_CONN_LIFETIME: "1h"
      # FLUXBASE_DATABASE_MAX_CONN_IDLE_TIME: "30m"
      # Optional: Separate admin user for migrations (defaults to user if not set)
      # FLUXBASE_DATABASE_ADMIN_USER: fluxbase_admin
      # Optional: User migrations path
      # FLUXBASE_DATABASE_USER_MIGRATIONS_PATH: /migrations/user

      # ==========================================================================
      # Authentication Configuration
      # ==========================================================================
      # CRITICAL: Generate secrets with: openssl rand -base64 32
      # Or use: scripts/generate-keys.sh
      FLUXBASE_AUTH_JWT_SECRET: haEae1GZfKa/lzMHyNFIR5iL0FZFIMMxMN3pb2jqCRc=
      FLUXBASE_AUTH_JWT_EXPIRY: 15m
      # FLUXBASE_AUTH_REFRESH_EXPIRY: "168h"
      # FLUXBASE_AUTH_MAGIC_LINK_EXPIRY: "15m"
      # FLUXBASE_AUTH_PASSWORD_RESET_EXPIRY: "1h"
      # FLUXBASE_AUTH_PASSWORD_MIN_LENGTH: "8"
      # FLUXBASE_AUTH_BCRYPT_COST: "10"
      # FLUXBASE_AUTH_ENABLE_SIGNUP: "true"
      # FLUXBASE_AUTH_ENABLE_MAGIC_LINK: "true"
      # FLUXBASE_AUTH_TOTP_ISSUER: "Fluxbase"

      # Anon Key: Pre-generated JWT with 'anon' role for client-side apps
      # Generate with: scripts/generate-keys.sh (option 3)
      # Use in client apps as: VITE_FLUXBASE_ANON_KEY, NEXT_PUBLIC_FLUXBASE_ANON_KEY, etc.
      # FLUXBASE_AUTH_ANON_KEY: ""

      # OAuth Providers (optional)
      # FLUXBASE_AUTH_GOOGLE_CLIENT_ID: ""
      # FLUXBASE_AUTH_APPLE_CLIENT_ID: ""
      # FLUXBASE_AUTH_MICROSOFT_CLIENT_ID: ""

      # ==========================================================================
      # Security Configuration
      # ==========================================================================
      # CRITICAL: Generate with: openssl rand -base64 32
      FLUXBASE_SECURITY_SETUP_TOKEN: ${FLUXBASE_SECURITY_SETUP_TOKEN:-your-secret-setup-token-change-in-production}
      # FLUXBASE_SECURITY_ENABLE_GLOBAL_RATE_LIMIT: "false"
      # FLUXBASE_SECURITY_ADMIN_SETUP_RATE_LIMIT: "5"
      # FLUXBASE_SECURITY_ADMIN_SETUP_RATE_WINDOW: "1m"
      # FLUXBASE_SECURITY_AUTH_LOGIN_RATE_LIMIT: "10"
      # FLUXBASE_SECURITY_AUTH_LOGIN_RATE_WINDOW: "1m"
      # FLUXBASE_SECURITY_ADMIN_LOGIN_RATE_LIMIT: "5"
      # FLUXBASE_SECURITY_ADMIN_LOGIN_RATE_WINDOW: "1m"

      # ==========================================================================
      # CORS Configuration
      # ==========================================================================
      # FLUXBASE_CORS_ALLOWED_ORIGINS: "*"
      # FLUXBASE_CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
      # FLUXBASE_CORS_ALLOWED_HEADERS: "*"
      # FLUXBASE_CORS_ALLOW_CREDENTIALS: "true"
      # FLUXBASE_CORS_MAX_AGE: "86400"

      # ==========================================================================
      # Storage Configuration
      # ==========================================================================
      FLUXBASE_STORAGE_PROVIDER: local
      FLUXBASE_STORAGE_LOCAL_PATH: /app/storage
      # FLUXBASE_STORAGE_MAX_UPLOAD_SIZE: "2147483648"  # 2GB

      # For S3-compatible storage (e.g., MinIO), uncomment below:
      # FLUXBASE_STORAGE_PROVIDER: s3
      # FLUXBASE_STORAGE_S3_BUCKET: fluxbase
      # FLUXBASE_STORAGE_S3_REGION: us-east-1
      # FLUXBASE_STORAGE_S3_ENDPOINT: http://minio:9000
      # FLUXBASE_STORAGE_S3_ACCESS_KEY: minioadmin
      # FLUXBASE_STORAGE_S3_SECRET_KEY: minioadmin
      # FLUXBASE_STORAGE_S3_FORCE_PATH_STYLE: "true"

      # ==========================================================================
      # Realtime (WebSocket) Configuration
      # ==========================================================================
      FLUXBASE_REALTIME_ENABLED: "true"
      # FLUXBASE_REALTIME_MAX_CONNECTIONS: "1000"
      # FLUXBASE_REALTIME_PING_INTERVAL: "30s"
      # FLUXBASE_REALTIME_PONG_TIMEOUT: "60s"
      # FLUXBASE_REALTIME_MESSAGE_SIZE_LIMIT: "524288"  # 512KB

      # ==========================================================================
      # Email Configuration (optional)
      # ==========================================================================
      # FLUXBASE_EMAIL_ENABLED: "false"
      # FLUXBASE_EMAIL_PROVIDER: "smtp"  # smtp, sendgrid, mailgun, ses
      # FLUXBASE_EMAIL_FROM_ADDRESS: "noreply@localhost"
      # FLUXBASE_EMAIL_FROM_NAME: "Fluxbase"

      # SMTP Configuration
      # FLUXBASE_EMAIL_SMTP_HOST: ""
      # FLUXBASE_EMAIL_SMTP_PORT: "587"
      # FLUXBASE_EMAIL_SMTP_USERNAME: ""
      # FLUXBASE_EMAIL_SMTP_PASSWORD: ""
      # FLUXBASE_EMAIL_SMTP_TLS: "true"

      # SendGrid Configuration
      # FLUXBASE_EMAIL_SENDGRID_API_KEY: ""

      # Mailgun Configuration
      # FLUXBASE_EMAIL_MAILGUN_API_KEY: ""
      # FLUXBASE_EMAIL_MAILGUN_DOMAIN: ""

      # AWS SES Configuration
      # FLUXBASE_EMAIL_SES_ACCESS_KEY: ""
      # FLUXBASE_EMAIL_SES_SECRET_KEY: ""
      # FLUXBASE_EMAIL_SES_REGION: "us-east-1"

      # ==========================================================================
      # Edge Functions Configuration
      # ==========================================================================
      FLUXBASE_FUNCTIONS_ENABLED: "true"
      FLUXBASE_FUNCTIONS_FUNCTIONS_DIR: /app/functions
      # FLUXBASE_FUNCTIONS_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_FUNCTIONS_DEFAULT_TIMEOUT: "30"
      # FLUXBASE_FUNCTIONS_MAX_TIMEOUT: "300"
      # FLUXBASE_FUNCTIONS_DEFAULT_MEMORY_LIMIT: "128"
      # FLUXBASE_FUNCTIONS_MAX_MEMORY_LIMIT: "1024"

      # ==========================================================================
      # Jobs Configuration
      # ==========================================================================
      # FLUXBASE_JOBS_ENABLED: "true"
      # FLUXBASE_JOBS_JOBS_DIR: "/app/jobs"
      # FLUXBASE_JOBS_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_JOBS_WORKER_MODE: "embedded"
      # FLUXBASE_JOBS_EMBEDDED_WORKER_COUNT: "4"
      # FLUXBASE_JOBS_MAX_CONCURRENT_PER_WORKER: "10"

      # ==========================================================================
      # REST API Configuration
      # ==========================================================================
      # FLUXBASE_API_MAX_PAGE_SIZE: "1000"
      # FLUXBASE_API_MAX_TOTAL_RESULTS: "10000"
      # FLUXBASE_API_DEFAULT_PAGE_SIZE: "1000"

      # ==========================================================================
      # Migrations Configuration
      # ==========================================================================
      # FLUXBASE_MIGRATIONS_ENABLED: "true"
      # FLUXBASE_MIGRATIONS_REQUIRE_SERVICE_KEY: "false"

      # ==========================================================================
      # RPC Configuration
      # ==========================================================================
      # FLUXBASE_RPC_ENABLED: "true"
      # FLUXBASE_RPC_PROCEDURES_DIR: "/app/procedures"
      # FLUXBASE_RPC_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_RPC_DEFAULT_MAX_EXECUTION_TIME: "30"
      # FLUXBASE_RPC_MAX_MAX_EXECUTION_TIME: "300"
      # FLUXBASE_RPC_DEFAULT_MAX_ROWS: "1000"

      # ==========================================================================
      # AI Configuration (optional)
      # ==========================================================================
      # FLUXBASE_AI_ENABLED: "false"
      # FLUXBASE_AI_CHATBOTS_DIR: "/app/chatbots"
      # FLUXBASE_AI_AUTO_LOAD_ON_BOOT: "true"
      # FLUXBASE_AI_DEFAULT_MAX_TOKENS: "4096"
      # FLUXBASE_AI_QUERY_TIMEOUT: "30s"
      # FLUXBASE_AI_MAX_ROWS_PER_QUERY: "1000"
      # FLUXBASE_AI_ENCRYPTION_KEY: ""  # Generate with: openssl rand -base64 32

      # OpenAI Configuration
      # FLUXBASE_AI_OPENAI_API_KEY: ""
      # FLUXBASE_AI_OPENAI_ORGANIZATION_ID: ""
      # FLUXBASE_AI_OPENAI_BASE_URL: ""

      # Azure OpenAI Configuration
      # FLUXBASE_AI_AZURE_API_KEY: ""
      # FLUXBASE_AI_AZURE_ENDPOINT: ""
      # FLUXBASE_AI_AZURE_DEPLOYMENT_NAME: ""
      # FLUXBASE_AI_AZURE_API_VERSION: ""

      # Ollama Configuration
      # FLUXBASE_AI_OLLAMA_ENDPOINT: ""
      # FLUXBASE_AI_OLLAMA_MODEL: ""

      # ==========================================================================
      # Logging Configuration
      # ==========================================================================
      # FLUXBASE_LOGGING_CONSOLE_ENABLED: "true"
      # FLUXBASE_LOGGING_CONSOLE_LEVEL: "info"
      # FLUXBASE_LOGGING_CONSOLE_FORMAT: "json"
      # FLUXBASE_LOGGING_BACKEND: "postgres"
      # FLUXBASE_LOGGING_BATCH_SIZE: "100"
      # FLUXBASE_LOGGING_FLUSH_INTERVAL: "5s"
      # FLUXBASE_LOGGING_PUBSUB_ENABLED: "true"
      # FLUXBASE_LOGGING_RETENTION_ENABLED: "true"
      # FLUXBASE_LOGGING_SYSTEM_RETENTION_DAYS: "30"
      # FLUXBASE_LOGGING_HTTP_RETENTION_DAYS: "7"
      # FLUXBASE_LOGGING_SECURITY_RETENTION_DAYS: "90"
      # FLUXBASE_LOGGING_EXECUTION_RETENTION_DAYS: "7"
      # FLUXBASE_LOGGING_AI_RETENTION_DAYS: "30"

      # ==========================================================================
      # Tracing Configuration (OpenTelemetry)
      # ==========================================================================
      # FLUXBASE_TRACING_ENABLED: "false"
      # FLUXBASE_TRACING_ENDPOINT: "localhost:4317"
      # FLUXBASE_TRACING_SERVICE_NAME: "fluxbase"
      # FLUXBASE_TRACING_ENVIRONMENT: "development"
      # FLUXBASE_TRACING_SAMPLE_RATE: "0.1"
      # FLUXBASE_TRACING_INSECURE: "true"

      # ==========================================================================
      # Admin Dashboard Configuration
      # ==========================================================================
      # Enable admin dashboard UI and API routes
      # Requires FLUXBASE_SECURITY_SETUP_TOKEN to also be set
      FLUXBASE_ADMIN_ENABLED: "false"

      # ==========================================================================
      # General Configuration
      # ==========================================================================
      FLUXBASE_BASE_URL: http://localhost:8080
      FLUXBASE_DEBUG: "false"

      # ==========================================================================
      # Horizontal Scaling Configuration - OPTIONAL
      # ==========================================================================
      # Backend options: "local" (default), "postgres", "redis"
      # - local: In-memory (single instance only)
      # - postgres: Uses PostgreSQL for distributed state (no extra dependencies)
      # - redis: Uses Redis-compatible backend (Dragonfly recommended)
      # FLUXBASE_SCALING_BACKEND: postgres
      # FLUXBASE_SCALING_ENABLE_SCHEDULER_LEADER_ELECTION: "true"
      # For Redis/Dragonfly backend:
      # FLUXBASE_SCALING_REDIS_URL: redis://dragonfly:6379
      # With password: FLUXBASE_SCALING_REDIS_URL: redis://:your-password@dragonfly:6379

    volumes:
      - storage_data:/app/storage
      - functions_data:/app/functions
      # Uncomment to enable user migrations:
      # - ./migrations/user:/migrations/user:ro
    depends_on:
      postgres:
        condition: service_healthy
      # Uncomment if using MinIO:
      # minio:
      #   condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - fluxbase
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  # Uncomment if using MinIO:
  # minio_data:
  #   driver: local
  # Uncomment if using Dragonfly:
  # dragonfly_data:
  #   driver: local
  storage_data:
    driver: local
  functions_data:
    driver: local

networks:
  fluxbase:
    driver: bridge
