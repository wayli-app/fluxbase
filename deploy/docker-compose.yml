version: "3.8"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:18-alpine
    container_name: fluxbase-postgres
    environment:
      POSTGRES_USER: fluxbase
      POSTGRES_PASSWORD: fluxbase
      POSTGRES_DB: fluxbase
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U fluxbase"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - fluxbase

  # MinIO (S3-compatible storage) - OPTIONAL
  # Uncomment this service if you want to use S3-compatible storage instead of local storage
  # Also update FLUXBASE_STORAGE_PROVIDER to 's3' in the fluxbase service below
  # minio:
  #   image: minio/minio:latest
  #   container_name: fluxbase-minio
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: minioadmin
  #     MINIO_ROOT_PASSWORD: minioadmin
  #   ports:
  #     - "9000:9000"   # S3 API
  #     - "9001:9001"   # Web Console
  #   volumes:
  #     - minio_data:/data
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
  #     interval: 30s
  #     timeout: 20s
  #     retries: 3
  #   networks:
  #     - fluxbase

  # Fluxbase API
  fluxbase:
    image: ghcr.io/wayli-app/fluxbase:0.0.1-rc.35
    container_name: fluxbase-api
    ports:
      - "8080:8080"
    environment:
      # Database Configuration
      FLUXBASE_DATABASE_HOST: postgres
      FLUXBASE_DATABASE_PORT: 5432
      FLUXBASE_DATABASE_DATABASE: fluxbase
      FLUXBASE_DATABASE_USER: fluxbase
      # Optional: Separate admin user for migrations (defaults to user if not set)
      # FLUXBASE_DATABASE_ADMIN_USER: fluxbase_admin
      FLUXBASE_DATABASE_PASSWORD: fluxbase
      FLUXBASE_DATABASE_SSL_MODE: disable

      # User Migrations (optional - uncomment to enable)
      # FLUXBASE_DATABASE_USER_MIGRATIONS_PATH: /migrations/user

      # Server Configuration
      FLUXBASE_SERVER_ADDRESS: "0.0.0.0:8080"

      # JWT Configuration
      # ⚠️  CRITICAL SECURITY WARNING ⚠️
      # The JWT secret below is a randomly generated example for development only.
      # For production, you MUST generate a new secret using:
      #   openssl rand -base64 32
      # Never commit your production JWT secret to version control!
      FLUXBASE_AUTH_JWT_SECRET: haEae1GZfKa/lzMHyNFIR5iL0FZFIMMxMN3pb2jqCRc=
      FLUXBASE_AUTH_JWT_EXPIRY: 15m

      # Security - Admin Setup Token (REQUIRED)
      # Generate with: openssl rand -base64 32
      FLUXBASE_SECURITY_SETUP_TOKEN: ${FLUXBASE_SECURITY_SETUP_TOKEN:-your-secret-setup-token-change-in-production}

      # API Keys (Optional - for client applications)
      #
      # Anon Key: JWT token with 'anon' role for client-side applications
      # Generate using: bash scripts/generate-keys.sh (select option 3)
      # Or use the pre-generated development key below (⚠️ DEVELOPMENT ONLY):
      # FLUXBASE_AUTH_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoiYW5vbiIsImVtYWlsIjoiIiwicm9sZSI6ImFub24iLCJzZXNzaW9uX2lkIjoiIiwidG9rZW5fdHlwZSI6ImFjY2VzcyIsImlzX2Fub255bW91cyI6dHJ1ZSwiaXNzIjoiZmx1eGJhc2UiLCJzdWIiOiJhbm9uIiwiaWF0IjoxNzAwMDAwMDAwLCJleHAiOjE3MzE1MzYwMDAsIm5iZiI6MTcwMDAwMDAwMCwianRpIjoiYW5vbiJ9.example
      #
      # Service Key: For backend services with elevated privileges (bypasses RLS)
      # Generate using: bash scripts/generate-keys.sh (select option 2)
      # Then store the key hash in the database (auth.service_keys table)
      # FLUXBASE_AUTH_SERVICE_KEY: sk_test_your-generated-service-key-here

      # Storage Configuration (using local storage for development)
      FLUXBASE_STORAGE_PROVIDER: local
      FLUXBASE_STORAGE_LOCAL_PATH: /app/storage

      # For S3-compatible storage (e.g., MinIO), uncomment below and comment out local storage:
      # FLUXBASE_STORAGE_PROVIDER: s3
      # FLUXBASE_STORAGE_S3_BUCKET: fluxbase
      # FLUXBASE_STORAGE_S3_REGION: us-east-1
      # FLUXBASE_STORAGE_S3_ENDPOINT: http://minio:9000
      # FLUXBASE_STORAGE_S3_ACCESS_KEY: minioadmin
      # FLUXBASE_STORAGE_S3_SECRET_KEY: minioadmin

      # Realtime Configuration
      FLUXBASE_REALTIME_ENABLED: "true"

      # Edge Functions Configuration
      FLUXBASE_FUNCTIONS_ENABLED: "true"
      FLUXBASE_FUNCTIONS_FUNCTIONS_DIR: /app/functions

      # General Configuration
      FLUXBASE_BASE_URL: http://localhost:8080
      FLUXBASE_DEBUG: "false"
    volumes:
      - storage_data:/app/storage
      - functions_data:/app/functions
      # Uncomment to enable user migrations:
      # - ./migrations/user:/migrations/user:ro
    depends_on:
      postgres:
        condition: service_healthy
      # Uncomment if using MinIO:
      # minio:
      #   condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - fluxbase
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  # Uncomment if using MinIO:
  # minio_data:
  #   driver: local
  storage_data:
    driver: local
  functions_data:
    driver: local

networks:
  fluxbase:
    driver: bridge
