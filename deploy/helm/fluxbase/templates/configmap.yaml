apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "fluxbase.fullname" . }}
  namespace: {{ include "fluxbase.namespace" . | quote }}
  labels: {{- include "fluxbase.labels" . | nindent 4 }}
  {{- if .Values.commonAnnotations }}
  annotations: {{- toYaml .Values.commonAnnotations | nindent 4 }}
  {{- end }}
data:
  fluxbase.yaml: |
    database:
      host: {{ include "fluxbase.databaseHost" . }}
      port: {{ include "fluxbase.databasePort" . }}
      name: {{ include "fluxbase.databaseName" . }}
      user: {{ include "fluxbase.databaseUser" . }}
      sslmode: {{ .Values.config.database.sslMode }}

    server:
      port: {{ .Values.config.server.port }}
      host: {{ .Values.config.server.host | quote }}

    jwt:
      expiration_minutes: {{ .Values.config.jwt.expirationMinutes }}

    storage:
      provider: {{ .Values.config.storage.provider | quote }}
      {{- if eq .Values.config.storage.provider "local" }}
      local:
        base_path: {{ .Values.config.storage.local.basePath | quote }}
      {{- else if eq .Values.config.storage.provider "s3" }}
      s3:
        bucket: {{ .Values.config.storage.s3.bucket | quote }}
        region: {{ .Values.config.storage.s3.region | quote }}
        endpoint: {{ .Values.config.storage.s3.endpoint | quote }}
      {{- end }}

    security:
      rate_limit:
        enabled: true
        requests_per_minute: 100

    observability:
      logging:
        level: "info"
        format: "json"
      metrics:
        enabled: {{ .Values.metrics.enabled }}
