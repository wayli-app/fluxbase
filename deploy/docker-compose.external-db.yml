version: "3.9"

# Docker Compose for Fluxbase with External Database
# Use this when you have an existing PostgreSQL instance (managed cloud database, existing on-prem DB, etc.)

services:
  # Fluxbase Application (without bundled PostgreSQL)
  fluxbase:
    image: ghcr.io/wayli-app/fluxbase:${FLUXBASE_VERSION:-0.0.1-rc.36}
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        VERSION: ${FLUXBASE_VERSION:-0.0.1-rc.36}
    container_name: fluxbase-app
    restart: unless-stopped
    environment:
      # Server
      FLUXBASE_SERVER_ADDRESS: :8080
      FLUXBASE_DEBUG: ${DEBUG:-false}
      FLUXBASE_LOG_LEVEL: ${LOG_LEVEL:-info}

      # External Database Configuration
      # Example connection strings for various providers:
      #
      # AWS RDS:
      #   FLUXBASE_DATABASE_HOST: mydb.abc123.us-east-1.rds.amazonaws.com
      #   FLUXBASE_DATABASE_PORT: 5432
      #   FLUXBASE_DATABASE_SSL_MODE: require
      #
      # Google Cloud SQL:
      #   FLUXBASE_DATABASE_HOST: 10.0.0.1  # Private IP
      #   FLUXBASE_DATABASE_PORT: 5432
      #   FLUXBASE_DATABASE_SSL_MODE: require
      #
      # Azure Database for PostgreSQL:
      #   FLUXBASE_DATABASE_HOST: myserver.postgres.database.azure.com
      #   FLUXBASE_DATABASE_PORT: 5432
      #   FLUXBASE_DATABASE_USER: myuser@myserver
      #   FLUXBASE_DATABASE_SSL_MODE: require
      #
      # Self-hosted PostgreSQL:
      #   FLUXBASE_DATABASE_HOST: postgres.example.com
      #   FLUXBASE_DATABASE_PORT: 5432
      #   FLUXBASE_DATABASE_SSL_MODE: disable  # or require/verify-ca/verify-full
      #
      FLUXBASE_DATABASE_HOST: ${DATABASE_HOST:?DATABASE_HOST is required}
      FLUXBASE_DATABASE_PORT: ${DATABASE_PORT:-5432}
      FLUXBASE_DATABASE_USER: ${DATABASE_USER:?DATABASE_USER is required}
      FLUXBASE_DATABASE_PASSWORD: ${DATABASE_PASSWORD:?DATABASE_PASSWORD is required}
      FLUXBASE_DATABASE_DATABASE: ${DATABASE_NAME:-fluxbase}
      FLUXBASE_DATABASE_SSL_MODE: ${DATABASE_SSL_MODE:-require}
      FLUXBASE_DATABASE_MAX_CONNECTIONS: ${DATABASE_MAX_CONNECTIONS:-25}
      FLUXBASE_DATABASE_MIN_CONNECTIONS: ${DATABASE_MIN_CONNECTIONS:-5}

      # Authentication
      FLUXBASE_AUTH_JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      FLUXBASE_AUTH_JWT_EXPIRY: 15m
      FLUXBASE_AUTH_REFRESH_EXPIRY: 168h
      FLUXBASE_AUTH_ENABLE_SIGNUP: ${ENABLE_SIGNUP:-true}

      # Security - Admin Setup Token (REQUIRED)
      FLUXBASE_SECURITY_SETUP_TOKEN: ${SETUP_TOKEN:?SETUP_TOKEN is required}

      # Storage - Local (can be changed to S3)
      FLUXBASE_STORAGE_PROVIDER: ${STORAGE_PROVIDER:-local}
      FLUXBASE_STORAGE_LOCAL_PATH: /app/storage

      # For S3 storage, uncomment and configure:
      # FLUXBASE_STORAGE_PROVIDER: s3
      # FLUXBASE_STORAGE_S3_BUCKET: ${S3_BUCKET}
      # FLUXBASE_STORAGE_S3_REGION: ${S3_REGION}
      # FLUXBASE_STORAGE_S3_ACCESS_KEY: ${S3_ACCESS_KEY}
      # FLUXBASE_STORAGE_S3_SECRET_KEY: ${S3_SECRET_KEY}
      # FLUXBASE_STORAGE_S3_ENDPOINT: ${S3_ENDPOINT:-}  # For MinIO or S3-compatible services

      # Realtime
      FLUXBASE_REALTIME_ENABLED: ${REALTIME_ENABLED:-true}

      # Base URL
      FLUXBASE_BASE_URL: ${BASE_URL:-http://localhost:8080}

      # Metrics
      FLUXBASE_METRICS_ENABLED: ${METRICS_ENABLED:-true}
    volumes:
      - fluxbase_storage:/app/storage
      - fluxbase_logs:/app/logs
      - fluxbase_functions:/app/functions
    ports:
      - "${FLUXBASE_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s # Give more time for external DB connection
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # Optional: MinIO for S3-compatible object storage
  # Uncomment if you need local object storage instead of external S3
  # minio:
  #   image: minio/minio:latest
  #   container_name: fluxbase-minio
  #   restart: unless-stopped
  #   command: server /data --console-address ":9001"
  #   environment:
  #     MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
  #     MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD is required}
  #   volumes:
  #     - minio_data:/data
  #   ports:
  #     - "9000:9000"
  #     - "9001:9001"

volumes:
  fluxbase_storage:
    driver: local
  fluxbase_logs:
    driver: local
  fluxbase_functions:
    driver: local
  # minio_data:
  #   driver: local
# Example .env file for external database:
#
# # Required
# DATABASE_HOST=your-database-host.example.com
# DATABASE_USER=fluxbase
# DATABASE_PASSWORD=your-secure-password
# JWT_SECRET=your-random-32-char-secret
#
# # Optional (with defaults)
# DATABASE_PORT=5432
# DATABASE_NAME=fluxbase
# DATABASE_SSL_MODE=require
# DATABASE_MAX_CONNECTIONS=25
# DATABASE_MIN_CONNECTIONS=5
# FLUXBASE_PORT=8080
# DEBUG=false
# LOG_LEVEL=info
# ENABLE_SIGNUP=true
# REALTIME_ENABLED=true
# BASE_URL=http://localhost:8080
# STORAGE_PROVIDER=local
# METRICS_ENABLED=true
#
# # For S3 storage
# # STORAGE_PROVIDER=s3
# # S3_BUCKET=my-bucket
# # S3_REGION=us-east-1
# # S3_ACCESS_KEY=your-access-key
# # S3_SECRET_KEY=your-secret-key
# # S3_ENDPOINT=  # Leave empty for AWS S3
#
# Database Requirements:
# ----------------------
# - PostgreSQL 13 or higher (18 recommended)
# - Required extensions: uuid-ossp, pg_trgm, pgcrypto
# - User needs CREATE privileges on the database
# - Minimum 1GB RAM, 10GB storage recommended
#
# Cloud Provider Examples:
# ------------------------
#
# AWS RDS:
#   DATABASE_HOST=mydb.abc123.us-east-1.rds.amazonaws.com
#   DATABASE_SSL_MODE=require
#   Ensure security group allows inbound on port 5432
#
# Google Cloud SQL:
#   DATABASE_HOST=10.0.0.1  # Use Private IP for better security
#   DATABASE_SSL_MODE=require
#   Enable Cloud SQL Proxy if connecting from outside GCP
#
# Azure Database for PostgreSQL:
#   DATABASE_HOST=myserver.postgres.database.azure.com
#   DATABASE_USER=myuser@myserver  # Note the @myserver suffix
#   DATABASE_SSL_MODE=require
#   Configure firewall rules to allow your IP
#
# DigitalOcean Managed Database:
#   DATABASE_HOST=your-db-cluster.db.ondigitalocean.com
#   DATABASE_PORT=25060  # Default port for DO managed DBs
#   DATABASE_SSL_MODE=require
#   Download SSL cert if using verify-ca or verify-full
#
# Supabase:
#   DATABASE_HOST=db.your-project.supabase.co
#   DATABASE_PORT=5432
#   DATABASE_SSL_MODE=require
#   Use connection pooler for better performance
