name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.25"
  POSTGRES_VERSION: "17"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get dependencies
        run: |
          go mod download
          go mod verify

      - name: Create dist directory with placeholder for embed directive
        run: |
          mkdir -p internal/adminui/dist
          echo '<!DOCTYPE html><html><head><title>Placeholder</title></head><body></body></html>' > internal/adminui/dist/index.html

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2

      - name: Run golangci-lint
        run: golangci-lint run --disable=typecheck ./...

      - name: Check go fmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Please run 'go fmt ./...'"
            gofmt -s -l .
            exit 1
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fluxbase_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
        # Configure PostgreSQL with custom settings
        # Note: In GitHub Actions, we need to use a workaround to pass postgres args
        # We'll do this via a step that restarts postgres after configuration

      mailhog:
        image: mailhog/mailhog:latest
        ports:
          - 1025:1025  # SMTP
          - 8025:8025  # Web UI

      minio:
        image: minio/minio:edge-cicd
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
        options: >-
          --health-cmd "curl --silent --fail http://localhost:9000/minio/health/live || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get dependencies
        run: |
          go mod download
          go mod verify

      - name: Setup database users
        env:
          PGPASSWORD: postgres
        run: |
          # Increase max_connections significantly for parallel test execution
          # ALTER SYSTEM requires a restart, so we'll apply settings and restart the container
          psql -h localhost -U postgres -d fluxbase_test -c "ALTER SYSTEM SET max_connections = 200;"
          psql -h localhost -U postgres -d fluxbase_test -c "ALTER SYSTEM SET superuser_reserved_connections = 1;"

          # Restart PostgreSQL to apply settings
          # Find the container ID for postgres service and restart it
          POSTGRES_CONTAINER=$(docker ps --filter "ancestor=postgres:17-alpine" --format "{{.ID}}")
          docker restart $POSTGRES_CONTAINER

          # Wait for postgres to be ready after restart
          sleep 5
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for postgres to be ready..."
            sleep 2
          done

          # Create fluxbase_app user for RLS testing with LOGIN privilege
          # Note: No CONNECTION LIMIT to allow tests to create many concurrent connections
          psql -h localhost -U postgres -d fluxbase_test -c "CREATE USER fluxbase_app WITH PASSWORD 'fluxbase_app_password' LOGIN;"
          psql -h localhost -U postgres -d fluxbase_test -c "GRANT ALL PRIVILEGES ON DATABASE fluxbase_test TO fluxbase_app;"

      - name: Run database migrations
        env:
          DATABASE_URL: "postgres://postgres:postgres@localhost:5432/fluxbase_test?sslmode=disable"
          PGPASSWORD: postgres
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
          migrate -path internal/database/migrations -database "$DATABASE_URL" up

          # Grant permissions to fluxbase_app after migrations
          SCHEMAS="public auth storage functions realtime dashboard"
          DB_USER="fluxbase_app"
          PSQL_CMD="psql -h localhost -U postgres -d fluxbase_test"

          # Grant USAGE and CREATE on all schemas
          for schema in $SCHEMAS; do
            $PSQL_CMD -c "GRANT USAGE, CREATE ON SCHEMA $schema TO $DB_USER;"
          done

          # Grant ALL PRIVILEGES on tables, sequences, and functions
          for schema in $SCHEMAS; do
            $PSQL_CMD -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA $schema TO $DB_USER;"
            $PSQL_CMD -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA $schema TO $DB_USER;"
          done

          # Grant EXECUTE on functions (needed for auth helpers and RPC endpoints)
          for schema in $SCHEMAS; do
            $PSQL_CMD -c "GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA $schema TO $DB_USER;"
          done

          # Change owner of all tables and sequences to fluxbase_app (required for upsert operations)
          $PSQL_CMD <<'EOFSQL'
          DO $$
          DECLARE
              r RECORD;
          BEGIN
              FOR r IN SELECT schemaname, tablename FROM pg_tables WHERE schemaname IN ('public', 'auth', 'storage', 'functions', 'realtime', 'dashboard')
              LOOP
                  EXECUTE 'ALTER TABLE ' || quote_ident(r.schemaname) || '.' || quote_ident(r.tablename) || ' OWNER TO fluxbase_app';
              END LOOP;

              FOR r IN SELECT schemaname, sequencename FROM pg_sequences WHERE schemaname IN ('public', 'auth', 'storage', 'functions', 'realtime', 'dashboard')
              LOOP
                  EXECUTE 'ALTER SEQUENCE ' || quote_ident(r.schemaname) || '.' || quote_ident(r.sequencename) || ' OWNER TO fluxbase_app';
              END LOOP;
          END$$;
          EOFSQL

      - name: Setup MinIO bucket
        run: |
          # Wait for MinIO to be ready
          timeout 30 bash -c 'until curl -f http://localhost:9000/minio/health/live; do sleep 1; done'

          # Install mc (MinIO client)
          wget https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc

          # Configure mc
          ./mc alias set minio http://localhost:9000 minioadmin minioadmin

          # Create test bucket
          ./mc mb minio/fluxbase-test || true
          ./mc anonymous set public minio/fluxbase-test

      - name: Create dist directory with placeholder for embed directive
        run: |
          mkdir -p internal/adminui/dist
          echo '<!DOCTYPE html><html><head><title>Placeholder</title></head><body></body></html>' > internal/adminui/dist/index.html

      - name: Run unit tests with coverage
        timeout-minutes: 5
        env:
          FLUXBASE_DATABASE_HOST: localhost
          FLUXBASE_DATABASE_PORT: 5432
          FLUXBASE_DATABASE_USER: postgres
          FLUXBASE_DATABASE_PASSWORD: postgres
          FLUXBASE_DATABASE_DATABASE: fluxbase_test
        run: |
          # Run unit tests with -short flag to skip integration tests
          # Integration tests require database setup and can be slow
          go test -v -short -race -timeout=3m -coverprofile=coverage.out -covermode=atomic $(go list ./... | grep -v '/test/e2e' | grep -v '/test$')
          go tool cover -html=coverage.out -o coverage.html

      - name: Run e2e tests
        timeout-minutes: 15
        env:
          FLUXBASE_DATABASE_HOST: localhost
          FLUXBASE_DATABASE_PORT: 5432
          FLUXBASE_DATABASE_USER: fluxbase_app
          FLUXBASE_DATABASE_PASSWORD: fluxbase_app_password
          FLUXBASE_DATABASE_DATABASE: fluxbase_test
          FLUXBASE_EMAIL_SMTP_HOST: localhost
          FLUXBASE_EMAIL_SMTP_PORT: 1025
          FLUXBASE_STORAGE_S3_ENDPOINT: localhost:9000
          FLUXBASE_STORAGE_S3_ACCESS_KEY: minioadmin
          FLUXBASE_STORAGE_S3_SECRET_KEY: minioadmin
          FLUXBASE_STORAGE_S3_BUCKET: fluxbase-test
        run: |
          # Run e2e tests with fluxbase_app user for proper RLS testing
          # Use -parallel=1 within each package to run test functions sequentially (avoid DB connection exhaustion)
          go test -v -race -parallel=1 -timeout=10m ./test/e2e/...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html

  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: admin/package-lock.json

      - name: Build SDKs and Admin UI
        run: |
          # Build SDK
          cd sdk
          npm ci
          npm run build

          # Build SDK React
          cd ../sdk-react
          npm ci
          npm run build

          # Build Admin UI (depends on SDKs)
          cd ../admin
          npm ci
          npm run build

          # Copy built files to internal/adminui/dist for embedding
          mkdir -p ../internal/adminui/dist
          cp -r dist/* ../internal/adminui/dist/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          output_name="fluxbase-${{ matrix.goos }}-${{ matrix.goarch }}"
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          go build -ldflags="-s -w -X main.Version=dev-${GITHUB_SHA::8} -X main.Commit=${GITHUB_SHA} -X main.BuildDate=${BUILD_DATE}" -o "dist/${output_name}" cmd/fluxbase/main.go

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fluxbase-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*

  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (test only, no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ghcr.io/${{ github.repository }}:test

