name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.25"
  POSTGRES_VERSION: "17"

jobs:
  lint-go:
    name: Lint Go
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get dependencies
        run: |
          go mod download
          go mod verify

      - name: Create dist directory with placeholder for embed directive
        run: |
          mkdir -p internal/adminui/dist
          echo '<!DOCTYPE html><html><head><title>Placeholder</title></head><body></body></html>' > internal/adminui/dist/index.html

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2

      - name: Run golangci-lint
        run: golangci-lint run --disable=typecheck ./...

      - name: Check go fmt
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "Please run 'go fmt ./...'"
            gofmt -s -l .
            exit 1
          fi

  lint-typescript:
    name: Lint TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: admin/package-lock.json

      - name: Install Admin dependencies
        working-directory: ./admin
        run: npm ci

      - name: Lint Admin
        working-directory: ./admin
        run: npm run lint

  test-sdk:
    name: Test SDK
    runs-on: ubuntu-latest
    needs: [lint-go, lint-typescript]
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: sdk/package-lock.json

      - name: Install SDK dependencies
        working-directory: ./sdk
        run: npm ci

      - name: Run SDK tests
        working-directory: ./sdk
        run: npm test -- src/admin.test.ts src/auth.test.ts src/management.test.ts src/ddl.test.ts src/impersonation.test.ts src/settings.test.ts src/oauth.test.ts

      - name: Type check SDK
        working-directory: ./sdk
        run: npm run type-check

      - name: Build SDK
        working-directory: ./sdk
        run: npm run build

      - name: Install SDK-React dependencies
        working-directory: ./sdk-react
        run: npm ci

      - name: Type check SDK-React
        working-directory: ./sdk-react
        run: npx tsc --noEmit

      - name: Build SDK-React
        working-directory: ./sdk-react
        run: npm run build

      - name: Install Admin dependencies
        working-directory: ./admin
        run: npm ci

      - name: Type check Admin
        working-directory: ./admin
        run: npx tsc -b

  test-go:
    name: Test Go
    runs-on: ubuntu-latest
    needs: [test-sdk]
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: fluxbase_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
        # Configure PostgreSQL with custom settings
        # Note: In GitHub Actions, we need to use a workaround to pass postgres args
        # We'll do this via a step that restarts postgres after configuration

      mailhog:
        image: mailhog/mailhog:latest
        ports:
          - 1025:1025 # SMTP
          - 8025:8025 # Web UI

      minio:
        image: minio/minio:edge-cicd
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
        options: >-
          --health-cmd "curl --silent --fail http://localhost:9000/minio/health/live || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Get dependencies
        run: |
          go mod download
          go mod verify

      - name: Setup database users
        env:
          PGPASSWORD: postgres
        run: |
          # Increase max_connections significantly for parallel test execution
          # ALTER SYSTEM requires a restart, so we'll apply settings and restart the container
          psql -h localhost -U postgres -d fluxbase_test -c "ALTER SYSTEM SET max_connections = 200;"
          psql -h localhost -U postgres -d fluxbase_test -c "ALTER SYSTEM SET superuser_reserved_connections = 1;"

          # Restart PostgreSQL to apply settings
          # Find the container ID for postgres service and restart it
          POSTGRES_CONTAINER=$(docker ps --filter "ancestor=postgres:18-alpine" --format "{{.ID}}")
          docker restart $POSTGRES_CONTAINER

          # Wait for postgres to be ready after restart
          sleep 5
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for postgres to be ready..."
            sleep 2
          done

          # Create fluxbase_app user with BYPASSRLS for migrations and general testing
          # This user can bypass RLS policies to manage data freely (like in production)
          # Note: No CONNECTION LIMIT to allow tests to create many concurrent connections
          psql -h localhost -U postgres -d fluxbase_test -c "CREATE USER fluxbase_app WITH PASSWORD 'fluxbase_app_password' LOGIN BYPASSRLS CREATEDB;"
          psql -h localhost -U postgres -d fluxbase_test -c "GRANT ALL PRIVILEGES ON DATABASE fluxbase_test TO fluxbase_app;"

          # Grant schema permissions to fluxbase_app for migrations
          psql -h localhost -U postgres -d fluxbase_test -c "GRANT ALL ON SCHEMA public TO fluxbase_app;"

          # Create _fluxbase schema if it doesn't exist and grant permissions
          psql -h localhost -U postgres -d fluxbase_test -c "CREATE SCHEMA IF NOT EXISTS _fluxbase;"
          psql -h localhost -U postgres -d fluxbase_test -c "GRANT ALL ON SCHEMA _fluxbase TO fluxbase_app;"

          # Create fluxbase_rls_test user specifically for RLS policy testing (without BYPASSRLS)
          # This user is ONLY used in RLS-specific tests to verify policies work correctly
          psql -h localhost -U postgres -d fluxbase_test -c "CREATE USER fluxbase_rls_test WITH PASSWORD 'fluxbase_rls_test_password' LOGIN NOBYPASSRLS CREATEDB;"
          psql -h localhost -U postgres -d fluxbase_test -c "GRANT ALL PRIVILEGES ON DATABASE fluxbase_test TO fluxbase_rls_test;"

      - name: Run database migrations
        env:
          # Run migrations as fluxbase_app user (same user tests will use)
          # This ensures consistent ownership and permissions
          DATABASE_URL: "postgres://fluxbase_app:fluxbase_app_password@localhost:5432/fluxbase_test?sslmode=disable"
          PGPASSWORD: postgres
        run: |
          go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
          migrate -path internal/database/migrations -database "$DATABASE_URL" up

          # Workaround: Create custom_settings table if it doesn't exist (migration issue to be fixed)
          PSQL_CMD="psql -h localhost -U postgres -d fluxbase_test"
          $PSQL_CMD << 'EOF'
            CREATE TABLE IF NOT EXISTS dashboard.custom_settings (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                key TEXT UNIQUE NOT NULL,
                value JSONB NOT NULL,
                value_type TEXT NOT NULL DEFAULT 'string' CHECK (value_type IN ('string', 'number', 'boolean', 'json')),
                description TEXT,
                editable_by TEXT[] NOT NULL DEFAULT ARRAY['dashboard_admin']::TEXT[],
                metadata JSONB DEFAULT '{}'::JSONB,
                created_by UUID REFERENCES dashboard.users(id) ON DELETE SET NULL,
                updated_by UUID REFERENCES dashboard.users(id) ON DELETE SET NULL,
                created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
            );
            CREATE INDEX IF NOT EXISTS idx_dashboard_custom_settings_key ON dashboard.custom_settings(key);
            CREATE INDEX IF NOT EXISTS idx_dashboard_custom_settings_editable_by ON dashboard.custom_settings USING GIN(editable_by);
            CREATE INDEX IF NOT EXISTS idx_dashboard_custom_settings_created_at ON dashboard.custom_settings(created_at);
            GRANT ALL ON dashboard.custom_settings TO fluxbase_app;
          EOF

          # Grant permissions to fluxbase_rls_test for RLS testing (AFTER migrations complete)
          SCHEMAS="_fluxbase public auth storage functions realtime dashboard"

          # Grant permissions on existing objects
          for schema in $SCHEMAS; do
            $PSQL_CMD -c "GRANT USAGE, CREATE ON SCHEMA $schema TO fluxbase_rls_test;"
            $PSQL_CMD -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA $schema TO fluxbase_rls_test;"
            $PSQL_CMD -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA $schema TO fluxbase_rls_test;"
            $PSQL_CMD -c "GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA $schema TO fluxbase_rls_test;"
          done

          # Also set default privileges for future objects created by fluxbase_app
          for schema in $SCHEMAS; do
            $PSQL_CMD -c "ALTER DEFAULT PRIVILEGES FOR ROLE fluxbase_app IN SCHEMA $schema GRANT ALL ON TABLES TO fluxbase_rls_test;"
            $PSQL_CMD -c "ALTER DEFAULT PRIVILEGES FOR ROLE fluxbase_app IN SCHEMA $schema GRANT ALL ON SEQUENCES TO fluxbase_rls_test;"
            $PSQL_CMD -c "ALTER DEFAULT PRIVILEGES FOR ROLE fluxbase_app IN SCHEMA $schema GRANT EXECUTE ON FUNCTIONS TO fluxbase_rls_test;"
          done

      - name: Setup MinIO bucket
        run: |
          # Wait for MinIO to be ready
          timeout 30 bash -c 'until curl -f http://localhost:9000/minio/health/live; do sleep 1; done'

          # Install mc (MinIO client)
          wget https://dl.min.io/client/mc/release/linux-amd64/mc
          chmod +x mc

          # Configure mc
          ./mc alias set minio http://localhost:9000 minioadmin minioadmin

          # Create test bucket
          ./mc mb minio/fluxbase-test || true
          ./mc anonymous set public minio/fluxbase-test

      - name: Create dist directory with placeholder for embed directive
        run: |
          mkdir -p internal/adminui/dist
          echo '<!DOCTYPE html><html><head><title>Placeholder</title></head><body></body></html>' > internal/adminui/dist/index.html

      - name: Run unit tests with coverage
        timeout-minutes: 5
        env:
          FLUXBASE_DATABASE_HOST: localhost
          FLUXBASE_DATABASE_PORT: 5432
          FLUXBASE_DATABASE_USER: postgres
          FLUXBASE_DATABASE_PASSWORD: postgres
          FLUXBASE_DATABASE_DATABASE: fluxbase_test
        run: |
          # Run unit tests with -short flag to skip integration tests
          # Integration tests require database setup and can be slow
          # Note: We run go test directly here for coverage, not through test-runner.sh
          go test -v -short -race -timeout=3m -coverprofile=coverage.out -covermode=atomic $(go list ./... | grep -v '/test/e2e' | grep -v '/test$')
          go tool cover -html=coverage.out -o coverage.html

      - name: Run e2e tests
        timeout-minutes: 15
        env:
          FLUXBASE_DATABASE_HOST: localhost
          FLUXBASE_DATABASE_PORT: 5432
          FLUXBASE_DATABASE_USER: fluxbase_app
          FLUXBASE_DATABASE_PASSWORD: fluxbase_app_password
          FLUXBASE_DATABASE_DATABASE: fluxbase_test
          FLUXBASE_EMAIL_SMTP_HOST: localhost
          FLUXBASE_EMAIL_SMTP_PORT: 1025
          FLUXBASE_STORAGE_S3_ENDPOINT: localhost:9000
          FLUXBASE_STORAGE_S3_ACCESS_KEY: minioadmin
          FLUXBASE_STORAGE_S3_SECRET_KEY: minioadmin
          FLUXBASE_STORAGE_S3_BUCKET: fluxbase-test
        run: |
          # Run e2e tests with fluxbase_app user for proper RLS testing
          # Use -parallel=1 within each package to run test functions sequentially (avoid DB connection exhaustion)
          # The test-runner.sh script provides real-time progress and cleaner output
          ./scripts/test-runner.sh go test -v -race -parallel=1 -timeout=10m ./test/e2e/...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            coverage.out
            coverage.html

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test-go]
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64

    steps:
      - uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: |
            sdk/package-lock.json
            sdk-react/package-lock.json
            admin/package-lock.json

      - name: Build SDKs
        run: |
          # Build SDK
          cd sdk
          npm ci
          npm run build

          # Build SDK React
          cd ../sdk-react
          npm ci
          npm run build

      - name: Build Admin UI
        run: |
          # Build Admin UI (depends on SDKs)
          cd admin
          npm ci
          npm run build

          # Copy built files to internal/adminui/dist for embedding
          mkdir -p ../internal/adminui/dist
          cp -r dist/* ../internal/adminui/dist/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          mkdir -p dist
          output_name="fluxbase-${{ matrix.goos }}-${{ matrix.goarch }}"
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          go build -ldflags="-s -w -X main.Version=dev-${GITHUB_SHA::8} -X main.Commit=${GITHUB_SHA} -X main.BuildDate=${BUILD_DATE}" -o "dist/${output_name}" cmd/fluxbase/main.go

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fluxbase-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*

  docker:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [test-go]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (test only, no push)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ghcr.io/${{ github.repository }}:test
