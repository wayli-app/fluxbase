# Fluxbase Configuration
# This file is optional - all settings can be configured via environment variables
# Environment variables use the prefix FLUXBASE_ and replace dots with underscores
# Example: server.address -> FLUXBASE_SERVER_ADDRESS

# Server configuration
server:
  address: ":8080"                      # FLUXBASE_SERVER_ADDRESS
  read_timeout: "15s"                   # FLUXBASE_SERVER_READ_TIMEOUT
  write_timeout: "15s"                  # FLUXBASE_SERVER_WRITE_TIMEOUT
  idle_timeout: "60s"                   # FLUXBASE_SERVER_IDLE_TIMEOUT
  body_limit: 2147483648                # FLUXBASE_SERVER_BODY_LIMIT (2GB)

# Database configuration
database:
  host: "localhost"                     # FLUXBASE_DATABASE_HOST
  port: 5432                            # FLUXBASE_DATABASE_PORT
  user: "postgres"                      # FLUXBASE_DATABASE_USER
  password: "postgres"                  # FLUXBASE_DATABASE_PASSWORD
  database: "fluxbase"                  # FLUXBASE_DATABASE_DATABASE
  ssl_mode: "disable"                   # FLUXBASE_DATABASE_SSL_MODE (disable, allow, prefer, require, verify-ca, verify-full)
  max_connections: 25                   # FLUXBASE_DATABASE_MAX_CONNECTIONS
  min_connections: 5                    # FLUXBASE_DATABASE_MIN_CONNECTIONS
  max_conn_lifetime: "1h"               # FLUXBASE_DATABASE_MAX_CONN_LIFETIME
  max_conn_idle_time: "30m"             # FLUXBASE_DATABASE_MAX_CONN_IDLE_TIME
  health_check_period: "1m"             # FLUXBASE_DATABASE_HEALTH_CHECK_PERIOD

# Authentication configuration
auth:
  jwt_secret: "your-secret-key-change-in-production"  # FLUXBASE_AUTH_JWT_SECRET (REQUIRED - must be changed!)
  jwt_expiry: "15m"                     # FLUXBASE_AUTH_JWT_EXPIRY
  refresh_expiry: "168h"                # FLUXBASE_AUTH_REFRESH_EXPIRY (7 days)
  magic_link_expiry: "15m"              # FLUXBASE_AUTH_MAGIC_LINK_EXPIRY
  password_reset_expiry: "1h"           # FLUXBASE_AUTH_PASSWORD_RESET_EXPIRY
  password_min_length: 8                # FLUXBASE_AUTH_PASSWORD_MIN_LENGTH
  bcrypt_cost: 10                       # FLUXBASE_AUTH_BCRYPT_COST (4-31, recommended 10-14)
  enable_signup: true                   # FLUXBASE_AUTH_ENABLE_SIGNUP
  enable_magic_link: true               # FLUXBASE_AUTH_ENABLE_MAGIC_LINK

  # Service Keys (optional - for backend services only)
  # Service keys provide elevated privileges that bypass RLS
  # WARNING: Service keys have full database access - use with extreme caution
  #
  # To create a service key:
  # 1. Generate random key: openssl rand -base64 32
  # 2. Format as: sk_live_<random> or sk_test_<random>
  # 3. Hash with bcrypt and store in auth.service_keys table:
  #    INSERT INTO auth.service_keys (name, description, key_hash, key_prefix, enabled)
  #    VALUES (
  #      'Backend Service',
  #      'Service key for backend API calls',
  #      crypt('sk_live_abc123...', gen_salt('bf', 12)),
  #      'sk_live_',
  #      true
  #    );
  # 4. Use via X-Service-Key header or Authorization: ServiceKey header
  #
  # service_key: ""                     # FLUXBASE_AUTH_SERVICE_KEY (optional, backend only)

  # SAML SSO Configuration (Enterprise Single Sign-On)
  # Configure SAML Identity Providers (IdPs) like Okta, Azure AD, OneLogin
  #
  # saml_providers:
  #   - name: okta                        # Provider identifier (used in URLs)
  #     enabled: true                     # Enable/disable this provider
  #     idp_metadata_url: "https://company.okta.com/app/xxx/sso/saml/metadata"
  #                                       # OR use idp_metadata_xml for inline XML
  #     entity_id: "https://your-app.com/auth/saml"  # SP Entity ID
  #     acs_url: "https://your-app.com/api/v1/auth/saml/acs"  # Assertion Consumer Service URL
  #     attribute_mapping:                # Map SAML attributes to user fields
  #       email: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress"
  #       name: "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name"
  #     auto_create_users: true           # Create users on first login
  #     default_role: "authenticated"     # Role for new SAML users
  #
  #     # Login target options:
  #     allow_app_login: true             # Allow for app user authentication (default: true)
  #     allow_dashboard_login: false      # Allow for dashboard admin SSO login (default: false)
  #                                       # When enabled, this provider appears on the dashboard login page
  #
  #     # Security options (recommended defaults shown):
  #     allow_idp_initiated: false        # Allow IdP-initiated SSO (security risk, default: false)
  #     allowed_redirect_hosts: []        # Whitelist for RelayState redirects (prevent open redirects)
  #                                       # Example: ["app.example.com", "dashboard.example.com"]
  #     allow_insecure_metadata_url: false  # Allow HTTP metadata URLs (default: false, requires HTTPS)
  #
  # SAML Setup Steps:
  # 1. Get your IdP metadata URL from Okta/Azure AD/OneLogin
  # 2. Configure a SAML application in your IdP with:
  #    - SP Entity ID: https://your-app.com/auth/saml
  #    - ACS URL: https://your-app.com/api/v1/auth/saml/acs
  #    - Name ID format: EmailAddress
  # 3. Add the provider configuration below
  # 4. Download SP metadata from: /api/v1/auth/saml/metadata/{provider}
  #
  # Security Considerations:
  # - IdP-initiated SSO is disabled by default to prevent replay attacks
  # - Metadata URLs must use HTTPS to prevent man-in-the-middle attacks
  # - RelayState redirects are validated against allowed_redirect_hosts to prevent open redirects
  # - User attributes (names) are sanitized to prevent XSS attacks

# Security settings
security:
  enable_global_rate_limit: false       # FLUXBASE_SECURITY_ENABLE_GLOBAL_RATE_LIMIT

  # CAPTCHA configuration for bot protection on authentication endpoints
  captcha:
    enabled: false                      # FLUXBASE_SECURITY_CAPTCHA_ENABLED
    provider: "hcaptcha"                # FLUXBASE_SECURITY_CAPTCHA_PROVIDER
                                        # Supported providers: hcaptcha, recaptcha_v3, turnstile, cap
    site_key: ""                        # FLUXBASE_SECURITY_CAPTCHA_SITE_KEY (public key for frontend)
    secret_key: ""                      # FLUXBASE_SECURITY_CAPTCHA_SECRET_KEY (private key for verification)
    score_threshold: 0.5                # FLUXBASE_SECURITY_CAPTCHA_SCORE_THRESHOLD (reCAPTCHA v3 only, 0.0-1.0)
    endpoints:                          # FLUXBASE_SECURITY_CAPTCHA_ENDPOINTS (comma-separated)
      - signup                          # Require CAPTCHA on user registration
      - login                           # Require CAPTCHA on sign in
      - password_reset                  # Require CAPTCHA on password reset request
      - magic_link                      # Require CAPTCHA on magic link request

    # Cap provider settings (self-hosted proof-of-work CAPTCHA)
    # Cap is a privacy-first, self-hosted alternative that uses proof-of-work instead of visual puzzles
    # See: https://capjs.js.org/
    # cap_server_url: "http://localhost:3000"  # FLUXBASE_SECURITY_CAPTCHA_CAP_SERVER_URL
    # cap_api_key: ""                          # FLUXBASE_SECURITY_CAPTCHA_CAP_API_KEY

    # Provider Setup Instructions:
    #
    # hCaptcha (privacy-focused, recommended):
    #   1. Sign up at https://www.hcaptcha.com/
    #   2. Create a new site and get your site key and secret key
    #   3. Set provider: "hcaptcha" and enter your keys
    #
    # reCAPTCHA v3 (invisible, risk scoring):
    #   1. Go to https://www.google.com/recaptcha/admin
    #   2. Register a new site with reCAPTCHA v3
    #   3. Set provider: "recaptcha_v3" and enter your keys
    #   4. Adjust score_threshold as needed (higher = stricter)
    #
    # Cloudflare Turnstile (free, privacy-friendly):
    #   1. Go to https://dash.cloudflare.com/?to=/:account/turnstile
    #   2. Add a new site and get your site key and secret key
    #   3. Set provider: "turnstile" and enter your keys
    #
    # Cap (self-hosted, proof-of-work):
    #   1. Run Cap server: docker run -p 3000:3000 ghcr.io/tiagozip/cap:latest
    #   2. Set provider: "cap" and cap_server_url to your Cap server URL
    #   3. Optionally set cap_api_key if you configured one in Cap

# Storage configuration
storage:
  provider: "local"                     # FLUXBASE_STORAGE_PROVIDER (local or s3)
  local_path: "./storage"               # FLUXBASE_STORAGE_LOCAL_PATH
  max_upload_size: 2147483648           # FLUXBASE_STORAGE_MAX_UPLOAD_SIZE (2GB)

  # S3 configuration (only required if provider is "s3")
  # s3_endpoint: "s3.amazonaws.com"     # FLUXBASE_STORAGE_S3_ENDPOINT
  # s3_access_key: ""                   # FLUXBASE_STORAGE_S3_ACCESS_KEY
  # s3_secret_key: ""                   # FLUXBASE_STORAGE_S3_SECRET_KEY
  # s3_bucket: ""                       # FLUXBASE_STORAGE_S3_BUCKET
  # s3_region: "us-east-1"              # FLUXBASE_STORAGE_S3_REGION

  # Image transformation configuration (requires libvips)
  # On-the-fly resize, crop, and format conversion
  # Usage: GET /api/v1/storage/bucket/image.jpg?w=300&h=200&fmt=webp&q=85&fit=cover
  transforms:
    enabled: true                       # FLUXBASE_STORAGE_TRANSFORMS_ENABLED
    default_quality: 80                 # FLUXBASE_STORAGE_TRANSFORMS_DEFAULT_QUALITY (1-100)
    max_width: 4096                     # FLUXBASE_STORAGE_TRANSFORMS_MAX_WIDTH
    max_height: 4096                    # FLUXBASE_STORAGE_TRANSFORMS_MAX_HEIGHT
    max_total_pixels: 16000000          # FLUXBASE_STORAGE_TRANSFORMS_MAX_TOTAL_PIXELS (16 megapixels)
    bucket_size: 50                     # FLUXBASE_STORAGE_TRANSFORMS_BUCKET_SIZE (dimension rounding)
    rate_limit: 60                      # FLUXBASE_STORAGE_TRANSFORMS_RATE_LIMIT (transforms/min/user)
    timeout: "30s"                      # FLUXBASE_STORAGE_TRANSFORMS_TIMEOUT
    max_concurrent: 4                   # FLUXBASE_STORAGE_TRANSFORMS_MAX_CONCURRENT
    cache_enabled: true                 # FLUXBASE_STORAGE_TRANSFORMS_CACHE_ENABLED
    cache_ttl: "24h"                    # FLUXBASE_STORAGE_TRANSFORMS_CACHE_TTL
    cache_max_size: 1073741824          # FLUXBASE_STORAGE_TRANSFORMS_CACHE_MAX_SIZE (1GB)

# Realtime/WebSocket configuration
realtime:
  enabled: true                         # FLUXBASE_REALTIME_ENABLED
  max_connections: 1000                 # FLUXBASE_REALTIME_MAX_CONNECTIONS
  ping_interval: "30s"                  # FLUXBASE_REALTIME_PING_INTERVAL
  pong_timeout: "60s"                   # FLUXBASE_REALTIME_PONG_TIMEOUT
  write_buffer_size: 1024               # FLUXBASE_REALTIME_WRITE_BUFFER_SIZE
  read_buffer_size: 1024                # FLUXBASE_REALTIME_READ_BUFFER_SIZE
  message_size_limit: 524288            # FLUXBASE_REALTIME_MESSAGE_SIZE_LIMIT (512KB)
  channel_buffer_size: 100              # FLUXBASE_REALTIME_CHANNEL_BUFFER_SIZE

# Email configuration
email:
  enabled: true                        # FLUXBASE_EMAIL_ENABLED
  provider: "smtp"                      # FLUXBASE_EMAIL_PROVIDER (smtp, sendgrid, mailgun, ses)
  from_address: "noreply@localhost"     # FLUXBASE_EMAIL_FROM_ADDRESS
  from_name: "Fluxbase"                 # FLUXBASE_EMAIL_FROM_NAME
  reply_to_address: ""                  # FLUXBASE_EMAIL_REPLY_TO_ADDRESS

  # SMTP configuration (required if provider is "smtp")
  smtp_host: ""                         # FLUXBASE_EMAIL_SMTP_HOST
  smtp_port: 587                        # FLUXBASE_EMAIL_SMTP_PORT
  smtp_username: ""                     # FLUXBASE_EMAIL_SMTP_USERNAME
  smtp_password: ""                     # FLUXBASE_EMAIL_SMTP_PASSWORD
  smtp_tls: true                        # FLUXBASE_EMAIL_SMTP_TLS

  # SendGrid configuration (required if provider is "sendgrid")
  # sendgrid_api_key: ""                # FLUXBASE_EMAIL_SENDGRID_API_KEY

  # Mailgun configuration (required if provider is "mailgun")
  # mailgun_api_key: ""                 # FLUXBASE_EMAIL_MAILGUN_API_KEY
  # mailgun_domain: ""                  # FLUXBASE_EMAIL_MAILGUN_DOMAIN

  # AWS SES configuration (required if provider is "ses")
  # ses_access_key: ""                  # FLUXBASE_EMAIL_SES_ACCESS_KEY
  # ses_secret_key: ""                  # FLUXBASE_EMAIL_SES_SECRET_KEY
  # ses_region: "us-east-1"             # FLUXBASE_EMAIL_SES_REGION

  # Email templates (optional)
  # magic_link_template: ""             # FLUXBASE_EMAIL_MAGIC_LINK_TEMPLATE
  # verification_template: ""           # FLUXBASE_EMAIL_VERIFICATION_TEMPLATE
  # password_reset_template: ""         # FLUXBASE_EMAIL_PASSWORD_RESET_TEMPLATE

# Edge Functions configuration
functions:
  enabled: true                         # FLUXBASE_FUNCTIONS_ENABLED
  functions_dir: "./functions"          # FLUXBASE_FUNCTIONS_FUNCTIONS_DIR (directory for function files)
  default_timeout: 30                   # FLUXBASE_FUNCTIONS_DEFAULT_TIMEOUT (seconds)
  max_timeout: 300                      # FLUXBASE_FUNCTIONS_MAX_TIMEOUT (max 5 minutes)
  default_memory_limit: 128             # FLUXBASE_FUNCTIONS_DEFAULT_MEMORY_LIMIT (MB)
  max_memory_limit: 1024                # FLUXBASE_FUNCTIONS_MAX_MEMORY_LIMIT (max 1GB)

# REST API configuration
api:
  max_page_size: 1000                   # FLUXBASE_API_MAX_PAGE_SIZE (max rows per request, -1 for unlimited)
  max_total_results: 10000              # FLUXBASE_API_MAX_TOTAL_RESULTS (max total rows via offset+limit, -1 for unlimited)
  default_page_size: 1000               # FLUXBASE_API_DEFAULT_PAGE_SIZE (applied when no limit specified, -1 for no default)

  # Pagination behavior:
  # - If a client requests ?limit=5000 and max_page_size=1000, they receive 1000 rows
  # - If a client requests ?offset=9500&limit=1000 and max_total_results=10000, they receive 500 rows
  # - If a client doesn't specify ?limit and default_page_size=1000, they receive 1000 rows
  # - Set any value to -1 to disable that limit (allows unlimited queries)

# GraphQL API configuration
graphql:
  enabled: true                         # FLUXBASE_GRAPHQL_ENABLED
  introspection: false                  # FLUXBASE_GRAPHQL_INTROSPECTION (disable in production)
  max_depth: 10                         # FLUXBASE_GRAPHQL_MAX_DEPTH (max query nesting depth)
  max_complexity: 1000                  # FLUXBASE_GRAPHQL_MAX_COMPLEXITY (max query complexity score)

  # Security notes:
  # - max_depth prevents deeply nested queries that cause exponential resource usage
  # - max_complexity limits total query cost (list fields cost more than scalar fields)
  # - introspection should be disabled in production to prevent schema discovery
  # - Example rejected query at depth 5:
  #   { users { posts { comments { author { posts { title } } } } } }

# AI/Chatbot configuration
ai:
  enabled: false                        # FLUXBASE_AI_ENABLED
  chatbots_dir: "./chatbots"            # FLUXBASE_AI_CHATBOTS_DIR
  auto_load_on_boot: true               # FLUXBASE_AI_AUTO_LOAD_ON_BOOT
  default_max_tokens: 4096              # FLUXBASE_AI_DEFAULT_MAX_TOKENS
  query_timeout: "30s"                  # FLUXBASE_AI_QUERY_TIMEOUT
  max_rows_per_query: 1000              # FLUXBASE_AI_MAX_ROWS_PER_QUERY
  conversation_cache_ttl: "1h"          # FLUXBASE_AI_CONVERSATION_CACHE_TTL
  max_conversation_turns: 50            # FLUXBASE_AI_MAX_CONVERSATION_TURNS

  # AI Provider Configuration (Optional - defaults to database-configured providers)
  # When configured here, the provider becomes read-only in the dashboard
  # and takes precedence over database providers
  provider_enabled: false               # FLUXBASE_AI_PROVIDER_ENABLED
  provider_type: "openai"               # FLUXBASE_AI_PROVIDER_TYPE (openai, azure, ollama)
  provider_name: "Default Provider"     # FLUXBASE_AI_PROVIDER_NAME
  provider_model: "gpt-4-turbo"         # FLUXBASE_AI_PROVIDER_MODEL

  # OpenAI Provider Settings (when provider_type is "openai")
  # openai_api_key: ""                  # FLUXBASE_AI_OPENAI_API_KEY (required for OpenAI)
  # openai_organization_id: ""          # FLUXBASE_AI_OPENAI_ORGANIZATION_ID
  # openai_base_url: ""                 # FLUXBASE_AI_OPENAI_BASE_URL (for OpenAI-compatible APIs)

  # Azure OpenAI Provider Settings (when provider_type is "azure")
  # azure_api_key: ""                   # FLUXBASE_AI_AZURE_API_KEY
  # azure_endpoint: ""                  # FLUXBASE_AI_AZURE_ENDPOINT (e.g., https://your-resource.openai.azure.com)
  # azure_deployment_name: ""           # FLUXBASE_AI_AZURE_DEPLOYMENT_NAME
  # azure_api_version: "2024-02-15-preview"  # FLUXBASE_AI_AZURE_API_VERSION

  # Ollama Provider Settings (when provider_type is "ollama")
  # ollama_endpoint: "http://localhost:11434"  # FLUXBASE_AI_OLLAMA_ENDPOINT
  # ollama_model: "llama2"              # FLUXBASE_AI_OLLAMA_MODEL

  # Embedding Configuration (for vector search and knowledge bases)
  embedding_enabled: false              # FLUXBASE_AI_EMBEDDING_ENABLED
  # embedding_provider: ""              # FLUXBASE_AI_EMBEDDING_PROVIDER (defaults to provider_type)
  embedding_model: "text-embedding-3-small"  # FLUXBASE_AI_EMBEDDING_MODEL

  # Available embedding models by provider:
  # - OpenAI: text-embedding-3-small (1536d), text-embedding-3-large (3072d), text-embedding-ada-002 (1536d)
  # - Azure: Same as OpenAI (requires deployment)
  # - Ollama: nomic-embed-text (768d), mxbai-embed-large (1024d), all-minilm (384d)

  # Azure Embedding Settings (optional - only if using separate Azure deployment for embeddings)
  # azure_embedding_deployment_name: "" # FLUXBASE_AI_AZURE_EMBEDDING_DEPLOYMENT_NAME

  # OCR Configuration (for image-based PDF extraction in knowledge bases)
  # OCR is used when standard PDF text extraction returns garbage/binary data (e.g., scanned documents)
  # Requires Tesseract and poppler-utils to be installed (included in Docker image)
  ocr_enabled: true                     # FLUXBASE_AI_OCR_ENABLED
  ocr_provider: "tesseract"             # FLUXBASE_AI_OCR_PROVIDER
  ocr_languages: "eng"                  # FLUXBASE_AI_OCR_LANGUAGES (comma-separated, e.g., eng,deu,nld,fra)

  # Available Tesseract language codes (install additional language packs as needed):
  # - eng (English), deu (German), nld (Dutch), fra (French), spa (Spanish), ita (Italian)
  # - por (Portuguese), rus (Russian), chi_sim (Chinese Simplified), jpn (Japanese), kor (Korean)

# General settings
base_url: "http://localhost:8080"       # FLUXBASE_BASE_URL - Internal URL for server-to-server communication
public_base_url: ""                     # FLUXBASE_PUBLIC_BASE_URL - Public URL for user-facing links (OAuth callbacks, magic links, invitations)
                                        # If not set, falls back to base_url. Set this when deploying behind a reverse proxy or load balancer.
                                        # Example: "https://api.example.com" while base_url remains "http://localhost:8080"
debug: false                            # FLUXBASE_DEBUG (enables debug logging)
