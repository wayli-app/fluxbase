#!/bin/bash
# Pre-commit hook for Fluxbase
# This hook runs Go formatting and TypeScript type checking before commits

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}Running pre-commit checks...${NC}"
echo ""

# Track if any checks failed
CHECKS_FAILED=0

# ============================================================================
# Go Formatting
# ============================================================================
echo -e "${YELLOW}[1/4] Checking Go formatting...${NC}"

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -n "$STAGED_GO_FILES" ]; then
    # Run go fmt on all Go code
    echo "  Running: go fmt ./..."
    if ! go fmt ./... > /dev/null 2>&1; then
        echo -e "${RED}✗ Go formatting failed${NC}"
        CHECKS_FAILED=1
    else
        # Check if go fmt made any changes to staged files
        MODIFIED_FILES=$(git diff --name-only $STAGED_GO_FILES 2>/dev/null || true)

        if [ -n "$MODIFIED_FILES" ]; then
            echo -e "${YELLOW}✓ Go files formatted (changes auto-staged)${NC}"
            # Auto-stage the formatted files
            git add $MODIFIED_FILES
        else
            echo -e "${GREEN}✓ Go formatting passed${NC}"
        fi
    fi
else
    echo -e "${GREEN}✓ No Go files to check${NC}"
fi

echo ""

# ============================================================================
# Admin TypeScript Type Checking
# ============================================================================
echo -e "${YELLOW}[2/4] Checking Admin TypeScript...${NC}"

STAGED_ADMIN_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^admin/.*\.tsx\?$' || true)

if [ -n "$STAGED_ADMIN_TS_FILES" ]; then
    if [ -d "admin/node_modules" ]; then
        echo "  Running: cd admin && npm run type-check"
        if ! (cd admin && npm run type-check > /dev/null 2>&1); then
            echo -e "${RED}✗ Admin TypeScript type checking failed${NC}"
            echo -e "${YELLOW}  Run 'cd admin && npm run type-check' to see errors${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}✓ Admin TypeScript type checking passed${NC}"
        fi
    else
        echo -e "${YELLOW}⚠ Skipping (node_modules not found - run 'cd admin && npm install')${NC}"
    fi
else
    echo -e "${GREEN}✓ No Admin TypeScript files to check${NC}"
fi

echo ""

# ============================================================================
# SDK TypeScript Type Checking
# ============================================================================
echo -e "${YELLOW}[3/4] Checking SDK TypeScript...${NC}"

STAGED_SDK_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^sdk/.*\.ts$' || true)

if [ -n "$STAGED_SDK_TS_FILES" ]; then
    if [ -d "sdk/node_modules" ]; then
        echo "  Running: cd sdk && npm run type-check"
        if ! (cd sdk && npm run type-check > /dev/null 2>&1); then
            echo -e "${RED}✗ SDK TypeScript type checking failed${NC}"
            echo -e "${YELLOW}  Run 'cd sdk && npm run type-check' to see errors${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}✓ SDK TypeScript type checking passed${NC}"
        fi
    else
        echo -e "${YELLOW}⚠ Skipping (node_modules not found - run 'cd sdk && npm install')${NC}"
    fi
else
    echo -e "${GREEN}✓ No SDK TypeScript files to check${NC}"
fi

echo ""

# ============================================================================
# SDK React TypeScript Type Checking
# ============================================================================
echo -e "${YELLOW}[4/4] Checking SDK React TypeScript...${NC}"

STAGED_SDK_REACT_TS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^sdk-react/.*\.tsx\?$' || true)

if [ -n "$STAGED_SDK_REACT_TS_FILES" ]; then
    if [ -d "sdk-react/node_modules" ]; then
        echo "  Running: cd sdk-react && npm run type-check"
        if ! (cd sdk-react && npm run type-check > /dev/null 2>&1); then
            echo -e "${RED}✗ SDK React TypeScript type checking failed${NC}"
            echo -e "${YELLOW}  Run 'cd sdk-react && npm run type-check' to see errors${NC}"
            CHECKS_FAILED=1
        else
            echo -e "${GREEN}✓ SDK React TypeScript type checking passed${NC}"
        fi
    else
        echo -e "${YELLOW}⚠ Skipping (node_modules not found - run 'cd sdk-react && npm install')${NC}"
    fi
else
    echo -e "${GREEN}✓ No SDK React TypeScript files to check${NC}"
fi

echo ""

# ============================================================================
# Final Result
# ============================================================================
if [ $CHECKS_FAILED -eq 1 ]; then
    echo -e "${RED}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║              PRE-COMMIT CHECKS FAILED                      ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}Fix the issues above and try again.${NC}"
    echo -e "${YELLOW}To skip these checks (not recommended), use: git commit --no-verify${NC}"
    echo ""
    exit 1
else
    echo -e "${GREEN}╔════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║          ALL PRE-COMMIT CHECKS PASSED ✓                    ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════╝${NC}"
    echo ""
fi

exit 0
